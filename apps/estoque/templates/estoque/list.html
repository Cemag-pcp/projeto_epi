{% extends "layout/base.html" %}

{% block title %}Estoque{% endblock %}

{% block content %}
  {% include "components/_alerts.html" %}
  {% include "components/_page_header.html" with title=title subtitle="Controle de estoque" create_url=create_url %}

  {% if filters %}
    {% include "components/_filters.html" with filters=filters %}
  {% endif %}

  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th scope="col">Produto</th>
          <th scope="col">CA</th>
          <th scope="col">Codigo</th>
          <th scope="col">Grade</th>
          <th scope="col">Deposito</th>
          <th scope="col">Quantidade</th>
          <th scope="col">Status</th>
          <th scope="col" class="text-end">Acoes</th>
        </tr>
      </thead>
      <tbody>
        {% for item in object_list %}
          <tr>
            <td>{{ item.produto }}</td>
            <td>{{ item.produto.ca|default:"-" }}</td>
            <td>{{ item.produto.codigo|default:"-" }}</td>
            <td>{{ item.grade|default:"-" }}</td>
            <td>{{ item.deposito }}</td>
            <td>{{ item.quantidade }}</td>
          <td>
            {% if item.quantidade|floatformat:2 == "0.00" or item.quantidade <= 0 %}
              <span class="text-danger" title="Estoque zerado"><i class="bi bi-exclamation-octagon-fill"></i></span>
            {% elif item.quantidade <= 5 %}
              <span class="text-warning" title="Estoque baixo"><i class="bi bi-exclamation-triangle-fill"></i></span>
            {% else %}
              <span class="text-success" title="Estoque ok"><i class="bi bi-check-circle-fill"></i></span>
            {% endif %}
          </td>
          <td class="text-end">
            {% if perms.estoque.add_movimentacaoestoque %}
              <button
                class="btn btn-outline-primary btn-icon"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#movModal-{{ item.pk }}"
                title="Movimentar"
                aria-label="Movimentar"
              >
                <i class="bi bi-arrow-left-right"></i>
              </button>
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
          <tr>
            <td colspan="8" class="text-muted text-center py-4">Sem registros</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% for row in movement_rows %}
    <div class="modal fade" id="movModal-{{ row.object.pk }}" tabindex="-1" aria-labelledby="movModalLabel-{{ row.object.pk }}" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="movModalLabel-{{ row.object.pk }}">Movimentar estoque</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <div class="fw-semibold">{{ row.object.produto }}</div>
              <div class="text-muted small">{{ row.object.deposito }}</div>
              {% if row.object.grade %}
                <div class="text-muted small">Grade: {{ row.object.grade }}</div>
              {% endif %}
            </div>
            {% include "estoque/_movimentacao_form.html" with form=row.form form_action=row.action_url %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  {% if create_form %}
    <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true" data-estoque-grades-url="{% url 'estoque:grades' %}">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createModalLabel">Novo estoque</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div data-estoque-create-modal-body>
              {% include "estoque/_estoque_form.html" with form=create_form form_action=create_url form_id="estoque-form" %}
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <script>
    (function () {
      function toggleDestino(form) {
        var tipoEl = form.querySelector("[name='tipo']");
        var destinoEl = form.querySelector("[name='deposito_destino']");
        var wrapper = form.querySelector("[data-mov-destino-wrapper]");
        if (!tipoEl || !destinoEl || !wrapper) {
          return;
        }
        var isTransferencia = (tipoEl.value || "") === "transferencia";
        wrapper.classList.toggle("d-none", !isTransferencia);
        destinoEl.disabled = !isTransferencia;
        if (!isTransferencia) {
          destinoEl.value = "";
        }
      }

      function bindMovForms() {
        document.querySelectorAll("[data-mov-form]").forEach(function (form) {
          if (form.dataset.bound === "1") {
            return;
          }
          form.dataset.bound = "1";
          var tipoEl = form.querySelector("[name='tipo']");
          if (tipoEl) {
            tipoEl.addEventListener("change", function () {
              toggleDestino(form);
            });
          }
          toggleDestino(form);
        });
      }

      function initGradeSelect() {
        var modalEl = document.getElementById("createModal");
        if (!modalEl) {
          return;
        }

        var gradesUrl = modalEl.getAttribute("data-estoque-grades-url");
        var modalBody = modalEl.querySelector("[data-estoque-create-modal-body]");
        var form = modalBody ? modalBody.querySelector("form") : null;
        if (!form) {
          return;
        }
        var produtoField = form.querySelector("[name='produto']");
        var gradeField = form.querySelector("[name='grade']");
        if (!produtoField || !gradeField) {
          return;
        }
        var token = String(Date.now()) + Math.random().toString(16).slice(2);
        modalEl.dataset.gradeBoundToken = token;

        function setSelectDisabled(selectEl, disabled) {
          if (!selectEl) return;
          selectEl.disabled = !!disabled;
          var instance = selectEl._choicesInstance;
          if (instance) {
            if (disabled) {
              instance.disable();
            } else {
              instance.enable();
            }
          }
        }

        function refreshChoices(selectEl) {
          if (window.clarusChoices && window.clarusChoices.refresh) {
            window.clarusChoices.refresh(selectEl);
          }
        }

        function resetGrades(message) {
          gradeField.innerHTML = "";
          var option = document.createElement("option");
          option.value = "";
          option.textContent = message || "Selecione um produto";
          gradeField.appendChild(option);
          setSelectDisabled(gradeField, true);
          refreshChoices(gradeField);
        }

        function populateGrades(items) {
          gradeField.innerHTML = "";
          var placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = "Selecione";
          gradeField.appendChild(placeholder);
          items.forEach(function (value) {
            var opt = document.createElement("option");
            opt.value = value;
            opt.textContent = value;
            gradeField.appendChild(opt);
          });
          setSelectDisabled(gradeField, false);
          refreshChoices(gradeField);
        }

        resetGrades();

        produtoField.addEventListener("change", function () {
          if (modalEl.dataset.gradeBoundToken !== token) {
            return;
          }
          if (!produtoField.value) {
            resetGrades();
            return;
          }
          if (!gradesUrl) {
            resetGrades("Nao foi possivel carregar grades");
            return;
          }
          resetGrades("Carregando...");
          fetch(gradesUrl + "?produto_id=" + encodeURIComponent(produtoField.value), {
            headers: { "X-Requested-With": "XMLHttpRequest" },
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (data) {
              if (!data || !data.ok) {
                resetGrades("Sem Grade");
                return;
              }
              if (data.grades && data.grades.length) {
                populateGrades(data.grades);
              } else {
                resetGrades("Sem Grade");
              }
            })
            .catch(function () {
              resetGrades("Erro ao carregar grades");
            });
        });
      }

      function showToast(message, level) {
        if (window.clarusToast) {
          window.clarusToast(message, level || "danger");
          return;
        }
        window.alert(message);
      }

      function bindCreateEstoqueForm() {
        var modalEl = document.getElementById("createModal");
        if (!modalEl) {
          return;
        }
        var modalBody = modalEl.querySelector("[data-estoque-create-modal-body]");
        var form = modalBody ? modalBody.querySelector("form") : null;
        if (!form) {
          return;
        }
        if (form.dataset.bound === "1") {
          return;
        }
        form.dataset.bound = "1";

        form.addEventListener("submit", function (event) {
          event.preventDefault();
          var formData = new FormData(form);
          fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
          })
            .then(function (response) {
              return response
                .json()
                .then(function (data) {
                  return { ok: response.ok, data: data };
                })
                .catch(function () {
                  return { ok: response.ok, data: null };
                });
            })
            .then(function (result) {
              if (!result.ok || !result.data || !result.data.ok) {
                if (modalBody && result.data && result.data.form_html) {
                  modalBody.innerHTML = result.data.form_html;
                  initGradeSelect();
                  bindCreateEstoqueForm();
                }
                showToast(
                  (result.data && result.data.message) || "Nao foi possivel salvar o estoque.",
                  "danger"
                );
                if (window.bootstrap) {
                  bootstrap.Modal.getOrCreateInstance(modalEl).show();
                }
                return;
              }

              showToast(result.data.message || "Criado com sucesso.", "success");
              if (modalBody && result.data.form_html) {
                modalBody.innerHTML = result.data.form_html;
                initGradeSelect();
                bindCreateEstoqueForm();
              }
              window.location.reload();
            })
            .catch(function () {
              form.submit();
            });
        });
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", function () {
          bindMovForms();
          initGradeSelect();
          bindCreateEstoqueForm();
        });
      } else {
        bindMovForms();
        initGradeSelect();
        bindCreateEstoqueForm();
      }
    })();
  </script>
{% endblock %}
