{% extends "layout/base.html" %}

{% block title %}Entregas{% endblock %}

{% block content %}
  {% include "components/_alerts.html" %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h4 mb-1">{{ title }}</h1>
      {% if subtitle %}<p class="text-muted mb-0">{{ subtitle }}</p>{% endif %}
    </div>
    {% if create_url %}
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#createModal">
          Novo
        </button>
        {% if can_add %}
          <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#createModal" data-entrega-solicitar-trigger>
            Solicitar entrega
          </button>
        {% endif %}
        {% if can_devolver %}
          <button class="btn btn-outline-success" type="button" data-bs-toggle="modal" data-bs-target="#devolucaoModal">
            Devolver
          </button>
        {% endif %}
      </div>
    {% endif %}
  </div>
  {% if filters %}
    <div data-entrega-filters>
      {% include "components/_filters.html" with filters=filters %}
    </div>
  {% endif %}

  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          {% for header in headers %}
            <th scope="col">{{ header }}</th>
          {% endfor %}
          <th scope="col" class="text-end">Acoes</th>
        </tr>
      </thead>
      <tbody data-entrega-rows>
        {% for object in object_list %}
          {% include "entregas/_entrega_row.html" with entrega=object %}
        {% empty %}
          <tr>
            <td colspan="{{ headers|length|add:1 }}" class="text-muted text-center py-4">Sem registros</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div data-entrega-pagination>
    {% include "components/_pagination.html" with page_obj=page_obj %}
  </div>

  {% if create_form %}
    <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createModalLabel">Nova entrega</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body" data-entrega-modal-body data-row-id="" data-entrega-depositos-url="{% url 'entregas:depositos' %}" data-entrega-produtos-url="{% url 'entregas:produtos' %}">
            <div data-entrega-form>
              {% include "entregas/_entrega_form.html" with form=create_form form_action=create_url form_id="entrega-form" form_hide_actions=True %}
            </div>
            <div class="alert alert-danger d-none" data-entrega-error></div>
            <div class="mt-4">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="mb-0">Itens adicionados</h6>
                <button
                  class="btn btn-outline-primary btn-icon"
                  type="button"
                  data-entrega-add-item
                  title="Adicionar item"
                  aria-label="Adicionar item"
                >
                  <i class="bi bi-plus"></i>
                </button>
              </div>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Funcionario</th>
                      <th>Produto / CA</th>
                      <th>Grade</th>
                      <th>Deposito</th>
                      <th>Quantidade</th>
                      <th class="text-end">Acoes</th>
                    </tr>
                  </thead>
                  <tbody data-entrega-items>
                    <tr>
                      <td colspan="6" class="text-muted text-center py-3">Nenhum item adicionado</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="d-flex gap-2 justify-content-end mt-3">
              <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
              <button class="btn btn-primary" type="submit" form="entrega-form">Salvar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <style>
    #entregaConfirmModal {
      z-index: 1080;
    }
    .entrega-confirm-backdrop {
      z-index: 1070;
    }
    #entregaValidacaoModal {
      z-index: 1090;
    }
    .entrega-validacao-backdrop {
      z-index: 1085;
    }
    .entrega-loading {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.35);
      z-index: 1100;
    }
  </style>

  {% include "components/_confirm_modal.html" with id="entregaConfirmModal" title_id="entregaConfirmModalLabel" title="Confirmar entrega" body="Item com estoque zero, deseja continuar?" confirm_text="Continuar" confirm_class="btn-warning" confirm_button_id="entrega-confirm-continue" %}
  <div class="modal fade" id="entregaCancelModal" tabindex="-1" aria-labelledby="entregaCancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entregaCancelModalLabel">Cancelar entrega</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">Deseja cancelar esta entrega?</div>
          <label class="form-label" for="entrega-cancel-motivo">Motivo do cancelamento</label>
          <textarea class="form-control" id="entrega-cancel-motivo" rows="3"></textarea>
          <div class="invalid-feedback d-block d-none" data-entrega-cancel-error></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Fechar</button>
          <button class="btn btn-danger" type="button" id="entrega-cancel-confirm">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="entregaMotivoModal" tabindex="-1" aria-labelledby="entregaMotivoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entregaMotivoModalLabel">Motivo do cancelamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" data-entrega-motivo-body>
          <div class="text-muted">Sem motivo informado.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="entregaDetailModal" tabindex="-1" aria-labelledby="entregaDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entregaDetailModalLabel">Detalhes da entrega</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" data-entrega-detail-body>
          <div class="text-muted">Carregando...</div>
        </div>
      </div>
    </div>
  </div>

  {% if can_devolver %}
    <div class="modal fade" id="devolucaoModal" tabindex="-1" aria-labelledby="devolucaoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="devolucaoModalLabel">Devolucao de material</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <form id="devolucao-form" action="{{ devolucao_confirmar_url }}" method="post">
              {% csrf_token %}
            </form>

            <div class="alert alert-danger d-none" data-devolucao-error></div>

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label" for="devolucao-funcionario">Funcionario</label>
                <select class="form-select" id="devolucao-funcionario">
                  <option value="">Selecione...</option>
                  {% for func in devolucao_funcionarios %}
                    <option value="{{ func.id }}">{{ func.registro|default:"-" }} - {{ func.nome }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="devolucao-item-select">Item recebido</label>
                <select class="form-select" id="devolucao-item-select" disabled>
                  <option value="">Selecione o funcionario...</option>
                </select>
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label" for="devolucao-quantidade">Quantidade</label>
                <input class="form-control" id="devolucao-quantidade" type="number" min="0.01" step="0.01" disabled>
                <div class="form-text" data-devolucao-saldo>Saldo: -</div>
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label" for="devolucao-condicao">Condicao</label>
                <select class="form-select" id="devolucao-condicao" disabled>
                  {% for value, label in condicao_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label" for="devolucao-motivo">Motivo/Obs.</label>
                <div class="d-flex align-items-center gap-3">
                  <input class="form-control" id="devolucao-motivo" type="text" disabled>
                  <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="devolucao-volta-estoque" checked disabled>
                    <label class="form-check-label" for="devolucao-volta-estoque">Volta para estoque</label>
                  </div>
                </div>
              </div>
              <div class="col-12 col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-primary w-100" type="button" id="devolucao-add" disabled>
                  Add
                </button>
              </div>
            </div>

            <hr class="my-4">

            <h6 class="mb-2">Itens recebidos</h6>
            <div class="table-responsive mb-4">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Entrega</th>
                    <th>Data</th>
                    <th>Produto</th>
                    <th>Deposito</th>
                    <th>Grade</th>
                    <th class="text-end">Saldo</th>
                  </tr>
                </thead>
                <tbody data-devolucao-items>
                  <tr>
                    <td colspan="6" class="text-muted text-center py-3">Selecione um funcionario para carregar.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <h6 class="mb-2">Resumo da devolucao</h6>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Item</th>
                    <th class="text-end">Quantidade</th>
                    <th>Condicao</th>
                    <th>Motivo</th>
                    <th>Estoque</th>
                    <th class="text-end">Acoes</th>
                  </tr>
                </thead>
                <tbody data-devolucao-resumo>
                  <tr>
                    <td colspan="6" class="text-muted text-center py-3">Nenhum item adicionado</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Fechar</button>
            <button class="btn btn-success" type="button" id="devolucao-confirmar" disabled>Confirmar devolucao</button>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <div class="modal fade" id="entregaValidacaoModal" tabindex="-1" aria-labelledby="entregaValidacaoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="entregaValidacaoModalLabel">Validacao de recebimento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" data-entrega-validacao-body>
          <p class="mb-3">Realize a validacao do funcionario para continuar.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" type="button" id="entrega-validacao-confirm">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="entregaLoading" class="entrega-loading d-none">
    <div class="spinner-border text-light" role="status" aria-hidden="true"></div>
    <div class="mt-2 text-light">Processando...</div>
  </div>

  <script>
    (function () {
        function showEntregaLoading() {
          var loading = document.getElementById("entregaLoading");
          if (!loading) {
            return;
          }
          loading.classList.remove("d-none");
        }

        function hideEntregaLoading() {
          var loading = document.getElementById("entregaLoading");
          if (!loading) {
            return;
          }
          loading.classList.add("d-none");
        }

        function ensureConfirmBackdrop() {
          var existing = document.querySelector(".entrega-confirm-backdrop");
          if (existing) {
            return existing;
          }
          var backdrop = document.createElement("div");
          backdrop.className = "modal-backdrop fade show entrega-confirm-backdrop";
          document.body.appendChild(backdrop);
          return backdrop;
        }

        function removeConfirmBackdrop() {
          var existing = document.querySelector(".entrega-confirm-backdrop");
          if (existing) {
            existing.remove();
          }
        }

        function ensureValidacaoBackdrop() {
          var existing = document.querySelector(".entrega-validacao-backdrop");
          if (existing) {
            return existing;
          }
          var backdrop = document.createElement("div");
          backdrop.className = "modal-backdrop fade show entrega-validacao-backdrop";
          document.body.appendChild(backdrop);
          return backdrop;
        }

        function removeValidacaoBackdrop() {
          var existing = document.querySelector(".entrega-validacao-backdrop");
          if (existing) {
            existing.remove();
          }
        }

        function renderValidacaoModal(modal, message, funcionarios, invalid, items, existingPayload) {
          var bodyEl = modal.querySelector("[data-entrega-validacao-body]");
          if (!bodyEl) {
            return;
          }
          bodyEl.innerHTML = "";
          var messageEl = document.createElement("p");
          messageEl.className = "mb-3";
          messageEl.textContent = message || "Realize a validacao do funcionario para continuar.";
          bodyEl.appendChild(messageEl);
          if (!funcionarios || !funcionarios.length) {
            return;
          }

          function setupSignaturePad(wrapper, canvas, initialValue) {
            var ctx = canvas.getContext("2d");
            var drawing = false;
            var hasDrawing = false;
            var height = 200;
            var width = wrapper.clientWidth || canvas.parentElement.clientWidth || 360;
            canvas.width = Math.max(width, 320);
            canvas.height = height;
            canvas.style.touchAction = "none";
            ctx.lineWidth = 2;
            ctx.lineJoin = "round";
            ctx.lineCap = "round";
            ctx.strokeStyle = "#111";

            function getPoint(event) {
              var rect = canvas.getBoundingClientRect();
              var clientX = event.clientX;
              var clientY = event.clientY;
              if (event.touches && event.touches.length) {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
              }
              return {
                x: clientX - rect.left,
                y: clientY - rect.top,
              };
            }

            function start(event) {
              drawing = true;
              var point = getPoint(event);
              ctx.beginPath();
              ctx.moveTo(point.x, point.y);
              event.preventDefault();
            }

            function move(event) {
              if (!drawing) {
                return;
              }
              var point = getPoint(event);
              ctx.lineTo(point.x, point.y);
              ctx.stroke();
              hasDrawing = true;
              event.preventDefault();
            }

            function end() {
              drawing = false;
            }

            canvas.addEventListener("pointerdown", start);
            canvas.addEventListener("pointermove", move);
            canvas.addEventListener("pointerup", end);
            canvas.addEventListener("pointerleave", end);
            canvas.addEventListener("pointercancel", end);

            function clear() {
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              hasDrawing = false;
            }

            function loadFromDataUrl(dataUrl) {
              if (!dataUrl) {
                return;
              }
              var img = new Image();
              img.onload = function () {
                clear();
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                hasDrawing = true;
              };
              img.src = dataUrl;
            }

            if (initialValue) {
              loadFromDataUrl(initialValue);
            }

            return {
              clear: clear,
              getValue: function () {
                if (!hasDrawing) {
                  return "";
                }
                return canvas.toDataURL("image/png");
              },
              load: loadFromDataUrl,
            };
          }

          function buildResumo(funcionarioId) {
            if (!items || !items.length) {
              return null;
            }
            var rows = items.filter(function (item) {
              return String(item.funcionario_id) === String(funcionarioId);
            });
            if (!rows.length) {
              return null;
            }
            var wrapper = document.createElement("div");
            wrapper.className = "mb-2";
            var title = document.createElement("div");
            title.className = "fw-semibold small";
            title.textContent = "Resumo da entrega";
            wrapper.appendChild(title);
            var table = document.createElement("table");
            table.className = "table table-sm align-middle mb-2";
            var thead = document.createElement("thead");
            thead.className = "table-light";
            thead.innerHTML = "<tr><th>Produto</th><th>Deposito</th><th>Quantidade</th></tr>";
            var tbody = document.createElement("tbody");
            rows.forEach(function (item) {
              var row = document.createElement("tr");
              var tdProduto = document.createElement("td");
              tdProduto.textContent = item.produto_fornecedor_label || "-";
              var tdDeposito = document.createElement("td");
              tdDeposito.textContent = item.deposito_label || "-";
              var tdQuantidade = document.createElement("td");
              tdQuantidade.textContent = item.quantidade || "-";
              row.appendChild(tdProduto);
              row.appendChild(tdDeposito);
              row.appendChild(tdQuantidade);
              tbody.appendChild(row);
            });
            table.appendChild(thead);
            table.appendChild(tbody);
            wrapper.appendChild(table);
            return wrapper;
          }
          funcionarios.forEach(function (funcionario) {
            var wrapper = document.createElement("div");
            wrapper.className = "mb-3";
            wrapper.setAttribute("data-funcionario-validacao-id", funcionario.id);
            wrapper.setAttribute("data-funcionario-validacao", funcionario.validacao || "senha");
            var resumo = buildResumo(funcionario.id);
            if (resumo) {
              wrapper.appendChild(resumo);
            }
            var tipo = funcionario.validacao || "senha";
            var label = document.createElement("div");
            label.className = "form-label fw-semibold";
            label.textContent =
              (tipo === "assinatura" ? "Assinatura de " : "Senha de ") + (funcionario.nome || "funcionario");
            wrapper.appendChild(label);
            if (tipo === "assinatura") {
              var helper = document.createElement("div");
              helper.className = "small text-muted mb-2";
              helper.textContent = "Assine na area abaixo usando a tela do dispositivo.";
              wrapper.appendChild(helper);
              var canvas = document.createElement("canvas");
              canvas.className = "border rounded w-100";
              canvas.height = 200;
              wrapper.appendChild(canvas);
              var actions = document.createElement("div");
              actions.className = "d-flex justify-content-between align-items-center mt-2";
              var legend = document.createElement("div");
              legend.className = "small text-muted";
              legend.textContent = "Use o dedo ou caneta para assinar.";
              var clearBtn = document.createElement("button");
              clearBtn.type = "button";
              clearBtn.className = "btn btn-sm btn-outline-secondary";
              clearBtn.textContent = "Limpar";
              actions.appendChild(legend);
              actions.appendChild(clearBtn);
              wrapper.appendChild(actions);
              var initialSignature =
                existingPayload && existingPayload[String(funcionario.id)]
                  ? existingPayload[String(funcionario.id)]
                  : "";
              var pad = setupSignaturePad(wrapper, canvas, initialSignature);
              clearBtn.addEventListener("click", function () {
                pad.clear();
              });
              wrapper._signaturePad = pad;
            } else {
              var input = document.createElement("input");
              input.type = "password";
              input.className = "form-control";
              input.value =
                existingPayload && existingPayload[String(funcionario.id)]
                  ? existingPayload[String(funcionario.id)]
                  : "";
              input.setAttribute("data-funcionario-validacao-id", funcionario.id);
              wrapper.appendChild(input);
            }
            if (invalid) {
              var feedback = document.createElement("div");
              feedback.className = "invalid-feedback d-block";
              feedback.textContent =
                tipo === "assinatura" ? "Assinatura invalida ou ausente." : "Senha invalida.";
              wrapper.appendChild(feedback);
            }
            bodyEl.appendChild(wrapper);
          });
        }

        function bindEntregaForm(form) {
          var items = [];
          var depositosUrl = null;
          var produtosUrl = null;
          var modalBody = form.closest("[data-entrega-modal-body]");
          if (modalBody) {
            depositosUrl = modalBody.getAttribute("data-entrega-depositos-url");
            produtosUrl = modalBody.getAttribute("data-entrega-produtos-url");
            if (modalBody.dataset.items) {
              try {
                items = JSON.parse(modalBody.dataset.items) || [];
              } catch (error) {
                items = [];
              }
            }
          }

        function ensurePayloadInput() {
          var input = form.querySelector("input[name='itens_payload']");
          if (!input) {
            input = document.createElement("input");
            input.type = "hidden";
            input.name = "itens_payload";
            form.appendChild(input);
          }
          return input;
        }

        function ensureAllowNegativeInput() {
          var input = form.querySelector("input[name='allow_negative']");
          if (!input) {
            input = document.createElement("input");
            input.type = "hidden";
            input.name = "allow_negative";
            form.appendChild(input);
          }
          return input;
        }

        function ensureValidacaoPayloadInput() {
          var input = form.querySelector("input[name='validacao_payload']");
          if (!input) {
            input = document.createElement("input");
            input.type = "hidden";
            input.name = "validacao_payload";
            form.appendChild(input);
          }
          return input;
        }

        function renderConfirmItems(modal, message, confirmItems) {
          var bodyEl = modal.querySelector(".modal-body");
          if (!bodyEl) {
            return;
          }
          bodyEl.innerHTML = "";
          var messageEl = document.createElement("p");
          messageEl.className = "mb-3";
          messageEl.textContent = message || "Item com estoque zero, deseja continuar?";
          bodyEl.appendChild(messageEl);
          if (!confirmItems || !confirmItems.length) {
            return;
          }
          var table = document.createElement("table");
          table.className = "table table-sm align-middle mb-0";
          var thead = document.createElement("thead");
          thead.className = "table-light";
          thead.innerHTML = "<tr><th>Produto</th><th>Deposito</th><th>Quantidade</th><th>Estoque</th></tr>";
          var tbody = document.createElement("tbody");
          confirmItems.forEach(function (item) {
            var row = document.createElement("tr");
            var tdProduto = document.createElement("td");
            tdProduto.textContent = item.produto || "-";
            var tdDeposito = document.createElement("td");
            tdDeposito.textContent = item.deposito || "-";
            var tdQuantidade = document.createElement("td");
            tdQuantidade.textContent = item.quantidade || "-";
            var tdEstoque = document.createElement("td");
            tdEstoque.textContent = item.estoque || "-";
            row.appendChild(tdProduto);
            row.appendChild(tdDeposito);
            row.appendChild(tdQuantidade);
            row.appendChild(tdEstoque);
            tbody.appendChild(row);
          });
          table.appendChild(thead);
          table.appendChild(tbody);
          bodyEl.appendChild(table);
        }

          function renderItems() {
            var tbody = modalBody ? modalBody.querySelector("[data-entrega-items]") : null;
            if (!tbody) {
              return;
            }
            var isReadonly = modalBody && modalBody.dataset.entregaMode === "readonly";
            if (modalBody) {
              modalBody.dataset.items = JSON.stringify(items);
            }
            if (!items.length) {
              tbody.innerHTML =
              '<tr><td colspan="6" class="text-muted text-center py-3">Nenhum item adicionado</td></tr>';
              return;
            }
            tbody.innerHTML = items
              .map(function (item, index) {
                return (
                  "<tr>" +
                  "<td>" +
                  item.funcionario_label +
                  "</td>" +
                  "<td>" +
                  item.produto_fornecedor_label +
                  "</td>" +
                  "<td>" +
                  (item.grade_label || "-") +
                  "</td>" +
                  "<td>" +
                  item.deposito_label +
                  "</td>" +
                  "<td>" +
                  item.quantidade +
                  "</td>" +
                '<td class="text-end">' +
                (isReadonly
                  ? '<span class="text-muted">-</span>'
                  : '<button class="btn btn-outline-danger btn-icon" type="button" data-entrega-remove="' +
                    index +
                    '" title="Remover" aria-label="Remover"><i class="bi bi-trash"></i></button>') +
                "</td>" +
                "</tr>"
              );
            })
            .join("");
        }

        form._setEntregaItems = function (newItems) {
          items = Array.isArray(newItems) ? newItems : [];
          renderItems();
        };
        form._renderEntregaItems = renderItems;

        function bindRemoveButtons() {
          var tbody = modalBody ? modalBody.querySelector("[data-entrega-items]") : null;
          if (!tbody) {
            return;
          }
          var token = String(Date.now()) + Math.random().toString(16).slice(2);
          tbody.dataset.boundToken = token;
          tbody.addEventListener("click", function (event) {
            if (tbody.dataset.boundToken !== token) {
              return;
            }
            var target = event.target;
            if (!target || !target.hasAttribute("data-entrega-remove")) {
              return;
            }
            if (modalBody && modalBody.dataset.entregaMode === "readonly") {
              return;
            }
            var index = parseInt(target.getAttribute("data-entrega-remove"), 10);
            if (isNaN(index)) {
              return;
            }
            items.splice(index, 1);
            renderItems();
          });
        }

        function bindAddButton() {
          var addButton = modalBody ? modalBody.querySelector("[data-entrega-add-item]") : null;
          if (!addButton) {
            return;
          }
          var token = String(Date.now()) + Math.random().toString(16).slice(2);
          addButton.dataset.boundToken = token;
          addButton.addEventListener("click", function () {
            if (addButton.dataset.boundToken !== token) {
              return;
            }
            if (modalBody && modalBody.dataset.entregaMode === "readonly") {
              return;
            }
            var funcionarioField = form.querySelector("[name='funcionario']");
            var produtoField = form.querySelector("[name='produto_fornecedor']");
            var depositoField = form.querySelector("[name='deposito']");
            var gradeField = form.querySelector("[name='grade']");
            var quantidadeField = form.querySelector("[name='quantidade']");
            var observacaoField = form.querySelector("[name='observacao']");
            if (!funcionarioField || !produtoField || !depositoField || !quantidadeField) {
              return;
            }
            if (!funcionarioField.value || !produtoField.value || !depositoField.value || !quantidadeField.value) {
              window.alert("Preencha funcionario, produto, deposito e quantidade.");
              return;
            }
            items.push({
              funcionario_id: funcionarioField.value,
              funcionario_label: funcionarioField.options[funcionarioField.selectedIndex].text,
              produto_fornecedor_id: produtoField.value,
              produto_fornecedor_label: produtoField.options[produtoField.selectedIndex].text,
              deposito_id: depositoField.value,
              deposito_label: depositoField.options[depositoField.selectedIndex].text,
              quantidade: quantidadeField.value,
              grade: gradeField ? gradeField.value : "",
              grade_label:
                gradeField && gradeField.value ? gradeField.options[gradeField.selectedIndex].text : "-",
              observacao: observacaoField ? observacaoField.value : "",
            });
            if (quantidadeField) {
              quantidadeField.value = "";
            }
            if (observacaoField) {
              observacaoField.value = "";
            }
            renderItems();
          });
        }

        function bindProdutoChange() {
          var produtoField = form.querySelector("[name='produto_fornecedor']");
          var depositoField = form.querySelector("[name='deposito']");
          var gradeField = form.querySelector("[name='grade']");
          if (!produtoField || !depositoField) {
            return;
          }
          function setSelectDisabled(selectEl, disabled) {
            if (!selectEl) return;
            selectEl.disabled = !!disabled;
            var instance = selectEl._choicesInstance;
            if (instance) {
              if (disabled) {
                instance.disable();
              } else {
                instance.enable();
              }
            }
          }
          function refreshChoices(selectEl) {
            if (window.clarusChoices && window.clarusChoices.refresh) {
              window.clarusChoices.refresh(selectEl);
            }
          }
          function resetDepositos(message) {
            depositoField.innerHTML = "";
            var option = document.createElement("option");
            option.value = "";
            option.textContent = message || "Selecione um produto";
            depositoField.appendChild(option);
            setSelectDisabled(depositoField, true);
            refreshChoices(depositoField);
          }
          function resetGrades(message) {
            if (!gradeField) {
              return;
            }
            gradeField.innerHTML = "";
            var option = document.createElement("option");
            option.value = "";
            option.textContent = message || "Selecione um produto";
            gradeField.appendChild(option);
            setSelectDisabled(gradeField, true);
            refreshChoices(gradeField);
          }
          function populateDepositos(items) {
            depositoField.innerHTML = "";
            var placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Selecione";
            depositoField.appendChild(placeholder);
            items.forEach(function (item) {
              var opt = document.createElement("option");
              opt.value = item.id;
              opt.textContent = item.nome;
              depositoField.appendChild(opt);
            });
            setSelectDisabled(depositoField, false);
            refreshChoices(depositoField);
          }
          function populateGrades(items) {
            if (!gradeField) {
              return;
            }
            gradeField.innerHTML = "";
            var placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Selecione";
            gradeField.appendChild(placeholder);
            items.forEach(function (value) {
              var opt = document.createElement("option");
              opt.value = value;
              opt.textContent = value;
              gradeField.appendChild(opt);
            });
            setSelectDisabled(gradeField, false);
            refreshChoices(gradeField);
          }
          resetDepositos();
          resetGrades();
          produtoField.addEventListener("change", function () {
            if (!produtoField.value) {
              resetDepositos();
              resetGrades();
              return;
            }
            if (!depositosUrl) {
              resetDepositos("Nao foi possivel carregar depositos");
              resetGrades("Nao foi possivel carregar grades");
              return;
            }
            resetDepositos("Carregando...");
            resetGrades("Carregando...");
            fetch(depositosUrl + "?produto_fornecedor_id=" + encodeURIComponent(produtoField.value), {
              headers: { "X-Requested-With": "XMLHttpRequest" },
            })
              .then(function (response) {
                return response.json();
              })
              .then(function (data) {
                if (!data || !data.ok) {
                  resetDepositos("Nenhum deposito encontrado");
                  resetGrades("Sem Grade");
                  return;
                }
                if (data.grades && data.grades.length) {
                  populateGrades(data.grades);
                } else {
                  resetGrades("Sem Grade");
                }
                if (!data.depositos || !data.depositos.length) {
                  resetDepositos("Nenhum deposito encontrado");
                  return;
                }
                populateDepositos(data.depositos);
              })
              .catch(function () {
                resetDepositos("Erro ao carregar depositos");
                resetGrades("Erro ao carregar grades");
              });
          });
        }

        function bindFuncionarioChange() {
          var funcionarioField = form.querySelector("[name='funcionario']");
          var produtoField = form.querySelector("[name='produto_fornecedor']");
          var depositoField = form.querySelector("[name='deposito']");
          var gradeField = form.querySelector("[name='grade']");
          if (!funcionarioField || !produtoField) {
            return;
          }
          function setSelectDisabled(selectEl, disabled) {
            if (!selectEl) return;
            selectEl.disabled = !!disabled;
            var instance = selectEl._choicesInstance;
            if (instance) {
              if (disabled) {
                instance.disable();
              } else {
                instance.enable();
              }
            }
          }
          function refreshChoices(selectEl) {
            if (window.clarusChoices && window.clarusChoices.refresh) {
              window.clarusChoices.refresh(selectEl);
            }
          }
          function resetProdutos(message) {
            produtoField.innerHTML = "";
            var option = document.createElement("option");
            option.value = "";
            option.textContent = message || "Selecione um funcionario";
            produtoField.appendChild(option);
            setSelectDisabled(produtoField, true);
            refreshChoices(produtoField);
            if (depositoField) {
              depositoField.innerHTML = "";
              var depoOpt = document.createElement("option");
              depoOpt.value = "";
              depoOpt.textContent = "Selecione um produto";
              depositoField.appendChild(depoOpt);
              setSelectDisabled(depositoField, true);
              refreshChoices(depositoField);
            }
            if (gradeField) {
              gradeField.innerHTML = "";
              var gradeOpt = document.createElement("option");
              gradeOpt.value = "";
              gradeOpt.textContent = "Selecione um produto";
              gradeField.appendChild(gradeOpt);
              setSelectDisabled(gradeField, true);
              refreshChoices(gradeField);
            }
          }
          function populateProdutos(items) {
            produtoField.innerHTML = "";
            var placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "Selecione";
            produtoField.appendChild(placeholder);
            items.forEach(function (item) {
              var opt = document.createElement("option");
              opt.value = item.id;
              opt.textContent = item.label;
              produtoField.appendChild(opt);
            });
            setSelectDisabled(produtoField, false);
            refreshChoices(produtoField);
          }
          resetProdutos();
          funcionarioField.addEventListener("change", function () {
            if (!funcionarioField.value) {
              resetProdutos();
              return;
            }
            if (!produtosUrl) {
              resetProdutos("Nao foi possivel carregar produtos");
              return;
            }
            resetProdutos("Carregando...");
            fetch(produtosUrl + "?funcionario_id=" + encodeURIComponent(funcionarioField.value), {
              headers: { "X-Requested-With": "XMLHttpRequest" },
            })
              .then(function (response) {
                return response.json();
              })
              .then(function (data) {
                if (!data || !data.ok) {
                  resetProdutos("Nenhum produto encontrado");
                  return;
                }
                if (!data.produtos || !data.produtos.length) {
                  resetProdutos("Nenhum produto encontrado");
                  return;
                }
                populateProdutos(data.produtos);
              })
              .catch(function () {
                resetProdutos("Erro ao carregar produtos");
              });
          });
        }

        bindAddButton();
        bindRemoveButtons();
        bindFuncionarioChange();
        bindProdutoChange();
        renderItems();

        form.noValidate = true;

        form.addEventListener("submit", function (event) {
          event.preventDefault();

          function submitForm(allowNegative, validacaoPayload) {
            var formData = new FormData(form);
            if (!items.length) {
              var funcionarioField = form.querySelector("[name='funcionario']");
              var produtoField = form.querySelector("[name='produto_fornecedor']");
              var depositoField = form.querySelector("[name='deposito']");
              var quantidadeField = form.querySelector("[name='quantidade']");
              if (
                !funcionarioField ||
                !produtoField ||
                !depositoField ||
                !quantidadeField ||
                !funcionarioField.value ||
                !produtoField.value ||
                !depositoField.value ||
                !quantidadeField.value
              ) {
                window.alert("Preencha funcionario, produto, deposito e quantidade.");
                return;
              }
            }
            if (items.length) {
              ensurePayloadInput().value = JSON.stringify(items);
              formData.set("itens_payload", JSON.stringify(items));
            } else {
              var payloadInput = form.querySelector("input[name='itens_payload']");
              if (payloadInput) {
                payloadInput.value = "";
              }
              formData.delete("itens_payload");
            }
            if (allowNegative) {
              ensureAllowNegativeInput().value = "1";
              formData.set("allow_negative", "1");
            } else {
              var allowInput = form.querySelector("input[name='allow_negative']");
              if (allowInput) {
                allowInput.value = "";
              }
              formData.delete("allow_negative");
            }
            if (validacaoPayload) {
              form._entregaValidacaoPayload = validacaoPayload;
            }
            if (form._entregaValidacaoPayload) {
              var payloadString = JSON.stringify(form._entregaValidacaoPayload);
              ensureValidacaoPayloadInput().value = payloadString;
              formData.set("validacao_payload", payloadString);
            } else {
              var validacaoInput = form.querySelector("input[name='validacao_payload']");
              if (validacaoInput) {
                validacaoInput.value = "";
              }
              formData.delete("validacao_payload");
            }
            showEntregaLoading();
            fetch(form.action, {
              method: "POST",
              body: formData,
              headers: { "X-Requested-With": "XMLHttpRequest" },
            })
              .then(function (response) {
                return response
                  .json()
                  .then(function (data) {
                    return { ok: response.ok, data: data };
                  })
                  .catch(function () {
                    return { ok: response.ok, data: null };
                  });
              })
              .then(function (result) {
                hideEntregaLoading();
                if (!result.ok || !result.data || !result.data.ok) {
                  if (result.data && result.data.confirm) {
                    var message = result.data.message || "Item com estoque zero, deseja continuar?";
                    var confirmModal = document.getElementById("entregaConfirmModal");
                    var confirmBtn = document.getElementById("entrega-confirm-continue");
                    if (confirmModal && confirmBtn && window.bootstrap) {
                      renderConfirmItems(confirmModal, message, result.data.confirm_items);
                      confirmBtn.setAttribute("data-allow", "1");
                      ensureConfirmBackdrop();
                      var instance = bootstrap.Modal.getOrCreateInstance(confirmModal);
                      confirmModal.addEventListener(
                        "hidden.bs.modal",
                        function () {
                          removeConfirmBackdrop();
                        },
                        { once: true }
                      );
                      instance.show();
                      return;
                    }
                    return;
                  }
                  if (result.data && result.data.validate) {
                    var message = result.data.message || "Realize a validacao do funcionario para continuar.";
                    var validacaoModal = document.getElementById("entregaValidacaoModal");
                    var confirmBtn = document.getElementById("entrega-validacao-confirm");
                    if (validacaoModal && confirmBtn && window.bootstrap) {
                      renderValidacaoModal(
                        validacaoModal,
                        message,
                        result.data.funcionarios || [],
                        result.data.invalid,
                        items,
                        form._entregaValidacaoPayload || null
                      );
                      ensureValidacaoBackdrop();
                      var instance = bootstrap.Modal.getOrCreateInstance(validacaoModal);
                      validacaoModal.addEventListener(
                        "hidden.bs.modal",
                        function () {
                          removeValidacaoBackdrop();
                        },
                        { once: true }
                      );
                      instance.show();
                      return;
                    }
                  }
                  if (modalBody && result.data && result.data.form_html) {
                    if (modalBody) {
                      modalBody.dataset.items = JSON.stringify(items);
                    }
                    var formContainer = modalBody.querySelector("[data-entrega-form]");
                    var errorBox = modalBody.querySelector("[data-entrega-error]");
                    var parsedMessage = "";
                    if (result.data.form_html) {
                      var parser = new DOMParser();
                      var doc = parser.parseFromString(result.data.form_html, "text/html");
                      var alertEl = doc.querySelector(".alert");
                      if (alertEl) {
                        parsedMessage = alertEl.textContent.trim();
                      }
                      if (!parsedMessage) {
                        var invalidEl = doc.querySelector(".invalid-feedback");
                        if (invalidEl) {
                          parsedMessage = invalidEl.textContent.trim();
                        }
                      }
                    }
                    if (errorBox) {
                      if (!parsedMessage) {
                        parsedMessage = "Erro ao validar a entrega.";
                      }
                      errorBox.textContent = parsedMessage;
                      errorBox.classList.remove("d-none");
                    }
                    if (formContainer) {
                      formContainer.innerHTML = result.data.form_html;
                      var newForm = formContainer.querySelector("form");
                      if (newForm) {
                        bindEntregaForm(newForm);
                      }
                    }
                  }
                  return;
                }

                if (result.data.action === "create") {
                  var tbody = document.querySelector("[data-entrega-rows]");
                  if (tbody) {
                    var emptyRow = tbody.querySelector("td.text-muted");
                    if (emptyRow) {
                      emptyRow.parentElement.remove();
                    }
                    tbody.insertAdjacentHTML("afterbegin", result.data.row_html);
                  }
                  bindEntregaCancel();
                  bindEntregaDetail();
                  bindEntregaMotivo();
                  bindEntregaAtender();
                  if (modalBody && result.data.form_html) {
                    if (modalBody) {
                      modalBody.dataset.items = "";
                    }
                    var formContainer = modalBody.querySelector("[data-entrega-form]");
                    var errorBox = modalBody.querySelector("[data-entrega-error]");
                    if (errorBox) {
                      errorBox.classList.add("d-none");
                      errorBox.textContent = "";
                    }
                    if (formContainer) {
                      formContainer.innerHTML = result.data.form_html;
                      var refreshedForm = formContainer.querySelector("form");
                      if (refreshedForm) {
                        bindEntregaForm(refreshedForm);
                      }
                    }
                  }
                  var modalEl = document.getElementById("createModal");
                  if (modalEl && window.bootstrap) {
                    bootstrap.Modal.getInstance(modalEl).hide();
                  }
                  return;
                }

                if (result.data.row_html && result.data.row_id) {
                  var row = document.getElementById("entrega-row-" + result.data.row_id);
                  if (row) {
                    row.outerHTML = result.data.row_html;
                  }
                  bindEntregaCancel();
                  bindEntregaDetail();
                  bindEntregaMotivo();
                  bindEntregaAtender();
                  var modalEl = document.getElementById("createModal");
                  if (modalEl && window.bootstrap) {
                    bootstrap.Modal.getInstance(modalEl).hide();
                  }
                }
              })
              .catch(function () {
                hideEntregaLoading();
                form.submit();
              });
          }

          form._submitEntregaAllowNegative = function () {
            submitForm(true);
          };
          form._submitEntregaComValidacao = function (payload) {
            submitForm(false, payload);
          };

          submitForm(false);
        });
      }

      function resetEntregaModal(form, titleText, actionUrl) {
        var modalEl = document.getElementById("createModal");
        if (modalEl) {
          var title = modalEl.querySelector("#createModalLabel");
          if (title && titleText) {
            title.textContent = titleText;
          }
        }
        if (form && actionUrl) {
          form.action = actionUrl;
        }
        if (form && typeof form._setEntregaItems === "function") {
          form._setEntregaItems([]);
        }
        if (form) {
          form._entregaValidacaoPayload = null;
          var validacaoInput = form.querySelector("input[name='validacao_payload']");
          if (validacaoInput) {
            validacaoInput.value = "";
          }
        }
        if (modalEl) {
          var errorBox = modalEl.querySelector("[data-entrega-error]");
          if (errorBox) {
            errorBox.classList.add("d-none");
            errorBox.textContent = "";
          }
        }
        setEntregaMode(form, "");
      }

      function setEntregaMode(form, mode) {
        if (!form) {
          return;
        }
        var modalBody = form.closest("[data-entrega-modal-body]");
        if (!modalBody) {
          return;
        }
        modalBody.dataset.entregaMode = mode || "";
        var formContainer = modalBody.querySelector("[data-entrega-form]");
        if (formContainer) {
          if (mode === "readonly") {
            formContainer.classList.add("d-none");
          } else {
            formContainer.classList.remove("d-none");
          }
        }
        var addButton = modalBody.querySelector("[data-entrega-add-item]");
        if (addButton) {
          if (mode === "readonly") {
            addButton.disabled = true;
            addButton.classList.add("disabled");
            addButton.setAttribute("aria-disabled", "true");
            addButton.classList.add("d-none");
          } else {
            addButton.disabled = false;
            addButton.classList.remove("disabled");
            addButton.removeAttribute("aria-disabled");
            addButton.classList.remove("d-none");
          }
        }
        if (typeof form._renderEntregaItems === "function") {
          form._renderEntregaItems();
        }
      }

      function bindEntregaModalReset() {
        var modalEl = document.getElementById("createModal");
        if (!modalEl || modalEl.dataset.resetBound === "1") {
          return;
        }
        modalEl.dataset.resetBound = "1";
        modalEl.addEventListener("hidden.bs.modal", function () {
          var form = modalEl.querySelector("form");
          if (!form) {
            return;
          }
          resetEntregaModal(form, "Nova entrega", "{{ create_url }}");
        });
      }

      function bindEntregaConfirm() {
        var confirmBtn = document.getElementById("entrega-confirm-continue");
        if (!confirmBtn || confirmBtn.dataset.bound === "1") {
          return;
        }
        confirmBtn.dataset.bound = "1";
        confirmBtn.addEventListener("click", function () {
          var modalEl = document.getElementById("entregaConfirmModal");
          if (modalEl && window.bootstrap) {
            bootstrap.Modal.getInstance(modalEl).hide();
          }
          removeConfirmBackdrop();
          var form = document.querySelector("#createModal form");
          if (!form) {
            return;
          }
          if (typeof form._submitEntregaAllowNegative === "function") {
            form._submitEntregaAllowNegative();
          }
        });

        var confirmModal = document.getElementById("entregaConfirmModal");
        if (confirmModal && !confirmModal.dataset.bound) {
          confirmModal.dataset.bound = "1";
          confirmModal.addEventListener("hidden.bs.modal", function () {
            var form = document.querySelector("#createModal form");
            if (!form) {
              return;
            }
            form._entregaValidacaoPayload = null;
            var input = form.querySelector("input[name='validacao_payload']");
            if (input) {
              input.value = "";
            }
          });
        }
      }

      function bindEntregaValidacaoConfirm() {
        var confirmBtn = document.getElementById("entrega-validacao-confirm");
        if (!confirmBtn || confirmBtn.dataset.bound === "1") {
          return;
        }
        confirmBtn.dataset.bound = "1";
        confirmBtn.addEventListener("click", function () {
          var modalEl = document.getElementById("entregaValidacaoModal");
          if (modalEl && window.bootstrap) {
            bootstrap.Modal.getInstance(modalEl).hide();
          }
          removeValidacaoBackdrop();
          var payload = {};
          var wrappers = modalEl ? modalEl.querySelectorAll("[data-funcionario-validacao]") : [];
          wrappers.forEach(function (wrapper) {
            var id = wrapper.getAttribute("data-funcionario-validacao-id");
            var tipo = wrapper.getAttribute("data-funcionario-validacao");
            if (!id) {
              return;
            }
            if (tipo === "assinatura" && wrapper._signaturePad) {
              payload[id] = wrapper._signaturePad.getValue();
              return;
            }
            var input = wrapper.querySelector("input[data-funcionario-validacao-id]");
            payload[id] = input ? input.value || "" : "";
          });
          if (typeof window.__entregaValidacaoHandler === "function") {
            var handler = window.__entregaValidacaoHandler;
            window.__entregaValidacaoHandler = null;
            handler(payload);
            return;
          }
          var form = document.querySelector("#createModal form");
          if (!form || typeof form._submitEntregaComValidacao !== "function") {
            return;
          }
          form._submitEntregaComValidacao(payload);
        });
      }

      function initEntregaForms() {
        var form = document.querySelector("#createModal form");
        if (form) {
          bindEntregaForm(form);
        }
      }

      function updateEntregaTable(html) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, "text/html");
        var newRows = doc.querySelector("[data-entrega-rows]");
        var newPagination = doc.querySelector("[data-entrega-pagination]");
        var currentRows = document.querySelector("[data-entrega-rows]");
        var currentPagination = document.querySelector("[data-entrega-pagination]");
        if (newRows && currentRows) {
          currentRows.innerHTML = newRows.innerHTML;
        }
        if (newPagination && currentPagination) {
          currentPagination.innerHTML = newPagination.innerHTML;
        }
        bindEntregaCancel();
        bindEntregaDetail();
        bindEntregaMotivo();
        bindEntregaAtender();
        bindEntregaPagination();
      }

      function bindEntregaDetail() {
        var triggers = document.querySelectorAll(".js-entrega-detail-trigger");
        triggers.forEach(function (trigger) {
          trigger.addEventListener("click", function () {
            var url = trigger.getAttribute("data-detail-url");
            var modalBody = document.querySelector("[data-entrega-detail-body]");
            if (modalBody) {
              modalBody.innerHTML = '<div class="text-muted">Carregando...</div>';
            }
            if (!url) {
              return;
            }
            fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
              .then(function (response) {
                return response
                  .json()
                  .then(function (data) {
                    return { ok: response.ok, data: data };
                  })
                  .catch(function () {
                    return { ok: response.ok, data: null };
                  });
              })
              .then(function (result) {
                if (!result.ok || !result.data || !result.data.ok) {
                  if (modalBody) {
                    modalBody.innerHTML = '<div class="text-danger">Erro ao carregar detalhes.</div>';
                  }
                  return;
                }
                if (modalBody) {
                  modalBody.innerHTML = result.data.html;
                }
              })
              .catch(function () {
                if (modalBody) {
                  modalBody.innerHTML = '<div class="text-danger">Erro ao carregar detalhes.</div>';
                }
              });
          });
        });
      }

      function bindEntregaDevolucao() {
        var modalBody = document.querySelector("[data-entrega-detail-body]");
        if (!modalBody || modalBody.dataset.devolucaoBound === "1") {
          return;
        }
        modalBody.dataset.devolucaoBound = "1";
        modalBody.addEventListener("submit", function (event) {
          var form = event.target;
          if (!form || !form.classList || !form.classList.contains("js-entrega-devolver-form")) {
            return;
          }
          event.preventDefault();
          var url = form.getAttribute("action");
          if (!url) {
            return;
          }
          var errorEl = modalBody.querySelector("[data-entrega-devolucao-error]");
          if (errorEl) {
            errorEl.textContent = "";
            errorEl.classList.add("d-none");
          }
          showEntregaLoading();
          fetch(url, {
            method: "POST",
            body: new FormData(form),
            headers: { "X-Requested-With": "XMLHttpRequest" },
          })
            .then(function (response) {
              return response
                .json()
                .then(function (data) {
                  return { ok: response.ok, data: data };
                })
                .catch(function () {
                  return { ok: response.ok, data: null };
                });
            })
            .then(function (result) {
              hideEntregaLoading();
              if (!result.ok || !result.data || !result.data.ok) {
                var message = (result.data && result.data.message) || "Erro ao registrar devolucao.";
                if (errorEl) {
                  errorEl.textContent = message;
                  errorEl.classList.remove("d-none");
                  return;
                }
                window.alert(message);
                return;
              }
              modalBody.innerHTML = result.data.html;
            })
            .catch(function () {
              hideEntregaLoading();
              if (errorEl) {
                errorEl.textContent = "Erro ao registrar devolucao.";
                errorEl.classList.remove("d-none");
                return;
              }
              window.alert("Erro ao registrar devolucao.");
            });
        });
      }

      function bindDevolucaoModal() {
        var modalEl = document.getElementById("devolucaoModal");
        if (!modalEl || modalEl.dataset.bound === "1") {
          return;
        }
        modalEl.dataset.bound = "1";
        modalEl._devolucaoState = {
          funcionarioId: "",
          itemsById: {},
          selected: [],
        };

        var funcionarioSelect = modalEl.querySelector("#devolucao-funcionario");
        var itemSelect = modalEl.querySelector("#devolucao-item-select");
        var qtdInput = modalEl.querySelector("#devolucao-quantidade");
        var condicaoSelect = modalEl.querySelector("#devolucao-condicao");
        var motivoInput = modalEl.querySelector("#devolucao-motivo");
        var voltaEstoqueInput = modalEl.querySelector("#devolucao-volta-estoque");
        var addBtn = modalEl.querySelector("#devolucao-add");
        var confirmBtn = modalEl.querySelector("#devolucao-confirmar");
        var saldoEl = modalEl.querySelector("[data-devolucao-saldo]");
        var itemsTbody = modalEl.querySelector("[data-devolucao-items]");
        var resumoTbody = modalEl.querySelector("[data-devolucao-resumo]");
        var errorEl = modalEl.querySelector("[data-devolucao-error]");
        var form = modalEl.querySelector("#devolucao-form");

        function setSelectDisabled(selectEl, disabled) {
          if (!selectEl) return;
          selectEl.disabled = !!disabled;
          var instance = selectEl._choicesInstance;
          if (instance && typeof instance.disable === "function" && typeof instance.enable === "function") {
            if (disabled) {
              instance.disable();
            } else {
              // Choices pode manter as opcoes como "disabled" se o <select> iniciou desabilitado.
              // Re-habilita o snapshot para que todas as opcoes fiquem selecionaveis.
              if (Array.isArray(selectEl._choicesSnapshot)) {
                selectEl._choicesSnapshot = selectEl._choicesSnapshot.map(function (item) {
                  return Object.assign({}, item, { disabled: false });
                });
              }
              instance.enable();
            }
          }
        }

        function refreshSelectChoices(selectEl, resetSnapshot) {
          if (!selectEl) return;
          if (window.clarusChoices && typeof window.clarusChoices.refresh === "function") {
            // Para selects dinamicos (ex: itemSelect), zeramos snapshot para nao misturar opcoes antigas.
            // Para selects estaticos (ex: condicao), nao resetar snapshot (Choices pode remover options do DOM).
            if (resetSnapshot) {
              selectEl._choicesSnapshot = [];
            }
            window.clarusChoices.refresh(selectEl);
          }
        }

        function showError(message) {
          if (!errorEl) return;
          errorEl.textContent = message || "Erro.";
          errorEl.classList.remove("d-none");
        }

        function clearError() {
          if (!errorEl) return;
          errorEl.textContent = "";
          errorEl.classList.add("d-none");
        }

        function setControlsEnabled(enabled) {
          setSelectDisabled(itemSelect, !enabled);
          if (qtdInput) qtdInput.disabled = !enabled;
          setSelectDisabled(condicaoSelect, !enabled);
          // Garante que o dropdown do Choices reflita o estado habilitado.
          refreshSelectChoices(condicaoSelect, false);
          if (motivoInput) motivoInput.disabled = !enabled;
          if (voltaEstoqueInput) voltaEstoqueInput.disabled = !enabled;
          if (addBtn) addBtn.disabled = !enabled;
        }

        function updateConfirmEnabled() {
          var hasItems = modalEl._devolucaoState.selected && modalEl._devolucaoState.selected.length > 0;
          if (confirmBtn) confirmBtn.disabled = !hasItems;
        }

        function renderItemsTable(items) {
          if (!itemsTbody) return;
          if (!items || !items.length) {
            itemsTbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">Nenhum item com saldo.</td></tr>';
            return;
          }
          itemsTbody.innerHTML = "";
          items.forEach(function (item) {
            var tr = document.createElement("tr");
            var dt = item.entregue_em ? new Date(item.entregue_em) : null;
            var dtLabel = dt ? dt.toLocaleString("pt-BR") : "-";
            tr.innerHTML =
              "<td>" + (item.entrega_label || "-") + "</td>" +
              "<td>" + dtLabel + "</td>" +
              "<td>" + (item.produto_label || "-") + "</td>" +
              "<td>" + (item.deposito_label || "-") + "</td>" +
              "<td>" + (item.grade || "-") + "</td>" +
              '<td class="text-end">' + (item.saldo || "-") + "</td>";
            itemsTbody.appendChild(tr);
          });
        }

        function renderItemSelect(items) {
          if (!itemSelect) return;
          itemSelect.innerHTML = "";
          if (!items || !items.length) {
            var opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "Nenhum item com saldo...";
            itemSelect.appendChild(opt);
            setSelectDisabled(itemSelect, true);
            refreshSelectChoices(itemSelect, true);
            return;
          }
          var placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = "Selecione...";
          itemSelect.appendChild(placeholder);
          items.forEach(function (item) {
            var opt = document.createElement("option");
            opt.value = item.entrega_item_id;
            opt.textContent =
              (item.entrega_label || "Entrega") +
              " | " +
              (item.produto_label || "-") +
              " | " +
              (item.deposito_label || "-") +
              " | Saldo " +
              (item.saldo || "-");
            itemSelect.appendChild(opt);
          });
          setSelectDisabled(itemSelect, false);
          refreshSelectChoices(itemSelect, true);
        }

        function renderResumo() {
          if (!resumoTbody) return;
          var selected = modalEl._devolucaoState.selected || [];
          if (!selected.length) {
            resumoTbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">Nenhum item adicionado</td></tr>';
            updateConfirmEnabled();
            return;
          }
          resumoTbody.innerHTML = "";
          selected.forEach(function (row, idx) {
            var tr = document.createElement("tr");
            tr.innerHTML =
              "<td>" + (row.label || "-") + "</td>" +
              '<td class="text-end">' + (row.quantidade || "-") + "</td>" +
              "<td>" + (row.condicao_label || row.condicao || "-") + "</td>" +
              "<td>" + (row.motivo || "-") + "</td>" +
              "<td>" + (row.volta_para_estoque ? "Sim" : "Nao") + "</td>" +
              '<td class="text-end"><button class="btn btn-sm btn-outline-danger" type="button" data-devolucao-remove="' + idx + '">Remover</button></td>';
            resumoTbody.appendChild(tr);
          });
          updateConfirmEnabled();
        }

        function loadItems(funcionarioId) {
          clearError();
          modalEl._devolucaoState.funcionarioId = funcionarioId;
          modalEl._devolucaoState.itemsById = {};
          modalEl._devolucaoState.selected = [];
          renderResumo();
          updateConfirmEnabled();
          if (saldoEl) saldoEl.textContent = "Saldo: -";
          if (!funcionarioId) {
            setControlsEnabled(false);
            if (itemSelect) {
              itemSelect.innerHTML = '<option value="">Selecione o funcionario...</option>';
              setSelectDisabled(itemSelect, true);
              refreshSelectChoices(itemSelect, true);
            }
            if (itemsTbody) {
              itemsTbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">Selecione um funcionario para carregar.</td></tr>';
            }
            return;
          }
          showEntregaLoading();
          fetch("{{ devolucao_itens_url }}?funcionario_id=" + encodeURIComponent(funcionarioId), {
            headers: { "X-Requested-With": "XMLHttpRequest" },
          })
            .then(function (response) {
              return response
                .json()
                .then(function (data) {
                  return { ok: response.ok, data: data };
                })
                .catch(function () {
                  return { ok: response.ok, data: null };
                });
            })
            .then(function (result) {
              hideEntregaLoading();
              if (!result.ok || !result.data || !result.data.ok) {
                setControlsEnabled(false);
                showError("Erro ao carregar itens do funcionario.");
                renderItemsTable([]);
                renderItemSelect([]);
                return;
              }
              var items = result.data.items || [];
              items.forEach(function (item) {
                modalEl._devolucaoState.itemsById[String(item.entrega_item_id)] = item;
              });
              renderItemsTable(items);
              renderItemSelect(items);
              setControlsEnabled(true);
              if (qtdInput) qtdInput.value = "";
              if (motivoInput) motivoInput.value = "";
              if (voltaEstoqueInput) voltaEstoqueInput.checked = true;
              if (saldoEl) saldoEl.textContent = "Saldo: -";
            })
            .catch(function () {
              hideEntregaLoading();
              setControlsEnabled(false);
              showError("Erro ao carregar itens do funcionario.");
              renderItemsTable([]);
              renderItemSelect([]);
            });
        }

        function getCondicaoLabel(value) {
          var map = {
            {% for value, label in condicao_choices %}
            "{{ value }}": "{{ label|escapejs }}",
            {% endfor %}
          };
          return map[value] || value || "-";
        }

        if (funcionarioSelect) {
          funcionarioSelect.addEventListener("change", function () {
            loadItems(funcionarioSelect.value);
          });
        }

        if (itemSelect) {
          itemSelect.addEventListener("change", function () {
            clearError();
            var itemId = itemSelect.value;
            var item = modalEl._devolucaoState.itemsById[String(itemId)];
            if (!item) {
              if (saldoEl) saldoEl.textContent = "Saldo: -";
              return;
            }
            if (saldoEl) saldoEl.textContent = "Saldo: " + (item.saldo || "-");
          });
        }

        if (addBtn) {
          addBtn.addEventListener("click", function () {
            clearError();
            var funcionarioId = modalEl._devolucaoState.funcionarioId;
            var itemId = itemSelect ? itemSelect.value : "";
            var item = modalEl._devolucaoState.itemsById[String(itemId)];
            if (!funcionarioId) {
              showError("Selecione o funcionario.");
              return;
            }
            if (!itemId || !item) {
              showError("Selecione um item.");
              return;
            }
            var quantidade = qtdInput ? (qtdInput.value || "").trim() : "";
            if (!quantidade) {
              showError("Informe a quantidade.");
              return;
            }
            var condicao = condicaoSelect ? condicaoSelect.value : "";
            var motivo = motivoInput ? (motivoInput.value || "").trim() : "";
            var voltaParaEstoque = voltaEstoqueInput ? !!voltaEstoqueInput.checked : true;
            var saldo = parseFloat(String(item.saldo || "0").replace(",", "."));
            var qtd = parseFloat(String(quantidade).replace(",", "."));
            if (!(qtd > 0)) {
              showError("Quantidade invalida.");
              return;
            }
            if (qtd > saldo) {
              showError("Quantidade excede o saldo.");
              return;
            }
            modalEl._devolucaoState.selected.push({
              funcionario_id: funcionarioId,
              entrega_item_id: item.entrega_item_id,
              quantidade: String(quantidade),
              condicao: condicao,
              condicao_label: getCondicaoLabel(condicao),
              motivo: motivo,
              volta_para_estoque: voltaParaEstoque,
              label: (item.entrega_label || "Entrega") + " | " + (item.produto_label || "-") + " | " + (item.deposito_label || "-") + " | " + (item.grade || "-"),
              produto_fornecedor_label: (item.produto_label || "-"),
              deposito_label: (item.deposito_label || "-"),
            });
            if (qtdInput) qtdInput.value = "";
            if (motivoInput) motivoInput.value = "";
            if (voltaEstoqueInput) voltaEstoqueInput.checked = true;
            if (itemSelect) itemSelect.value = "";
            if (saldoEl) saldoEl.textContent = "Saldo: -";
            renderResumo();
          });
        }

        if (resumoTbody) {
          resumoTbody.addEventListener("click", function (event) {
            var target = event.target;
            if (!target || !target.getAttribute) return;
            var idx = target.getAttribute("data-devolucao-remove");
            if (idx === null || idx === undefined) return;
            var index = parseInt(idx, 10);
            if (isNaN(index)) return;
            modalEl._devolucaoState.selected.splice(index, 1);
            renderResumo();
          });
        }

        function submitDevolucao(validacaoPayload) {
          clearError();
          if (!form) {
            showError("Formulario nao encontrado.");
            return;
          }
          var selected = modalEl._devolucaoState.selected || [];
          if (!selected.length) {
            showError("Adicione ao menos um item.");
            return;
          }
          var formData = new FormData(form);
          formData.set("itens_payload", JSON.stringify(selected));
          formData.set("validacao_payload", JSON.stringify(validacaoPayload || {}));
          showEntregaLoading();
          fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
          })
            .then(function (response) {
              return response
                .json()
                .then(function (data) {
                  return { ok: response.ok, data: data };
                })
                .catch(function () {
                  return { ok: response.ok, data: null };
                });
            })
            .then(function (result) {
              hideEntregaLoading();
              if (result.ok && result.data && result.data.ok) {
                var instance = bootstrap.Modal.getInstance(modalEl);
                if (instance) instance.hide();
                return;
              }
              if (result.data && result.data.validate) {
                var validacaoModal = document.getElementById("entregaValidacaoModal");
                if (!validacaoModal || !window.bootstrap) {
                  showError(result.data.message || "Validacao necessaria.");
                  return;
                }
                window.__entregaValidacaoHandler = function (payload) {
                  submitDevolucao(payload);
                };
                var resumoItems = selected.map(function (row) {
                  return {
                    funcionario_id: row.funcionario_id,
                    produto_fornecedor_label: row.produto_fornecedor_label || "-",
                    deposito_label: row.deposito_label || "-",
                    quantidade: row.quantidade || "-",
                  };
                });
                var modal = new bootstrap.Modal(validacaoModal, { backdrop: false });
                ensureValidacaoBackdrop();
                renderValidacaoModal(validacaoModal, result.data.message, result.data.funcionarios, result.data.invalid, resumoItems, validacaoPayload || {});
                modal.show();
                return;
              }
              showError((result.data && result.data.message) || "Erro ao confirmar devolucao.");
            })
            .catch(function () {
              hideEntregaLoading();
              showError("Erro ao confirmar devolucao.");
            });
        }

        if (confirmBtn) {
          confirmBtn.addEventListener("click", function () {
            submitDevolucao(null);
          });
        }

        modalEl.addEventListener("hidden.bs.modal", function () {
          clearError();
          modalEl._devolucaoState.funcionarioId = "";
          modalEl._devolucaoState.itemsById = {};
          modalEl._devolucaoState.selected = [];
          if (funcionarioSelect) funcionarioSelect.value = "";
          setControlsEnabled(false);
          if (itemSelect) {
            itemSelect.innerHTML = '<option value="">Selecione o funcionario...</option>';
            setSelectDisabled(itemSelect, true);
            refreshSelectChoices(itemSelect, true);
          }
          if (qtdInput) qtdInput.value = "";
          if (motivoInput) motivoInput.value = "";
          if (voltaEstoqueInput) voltaEstoqueInput.checked = true;
          if (saldoEl) saldoEl.textContent = "Saldo: -";
          if (itemsTbody) {
            itemsTbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">Selecione um funcionario para carregar.</td></tr>';
          }
          renderResumo();
          updateConfirmEnabled();
        });
      }

      function bindEntregaSolicitar() {
        var trigger = document.querySelector("[data-entrega-solicitar-trigger]");
        if (!trigger || trigger.dataset.bound === "1") {
          return;
        }
        trigger.dataset.bound = "1";
        trigger.addEventListener("click", function () {
          var form = document.querySelector("#createModal form");
          if (!form) {
            return;
          }
          resetEntregaModal(form, "Solicitar entrega", "{{ solicitacao_url }}");
        });
      }

      function bindEntregaAtender() {
        var root = document.body;
        if (!root || root.dataset.entregaAtenderBound === "1") {
          return;
        }
        root.dataset.entregaAtenderBound = "1";
        root.addEventListener("click", function (event) {
          var target = event.target;
          if (!target || !target.closest) {
            return;
          }
          var trigger = target.closest(".js-entrega-atender-trigger");
          if (!trigger) {
            return;
          }
          var form = document.querySelector("#createModal form");
          if (!form) {
            return;
          }
          var entregarUrl = trigger.getAttribute("data-entregar-url");
          var itensUrl = trigger.getAttribute("data-itens-url");
          resetEntregaModal(form, "Entregar", entregarUrl);
          setEntregaMode(form, "readonly");
          if (!itensUrl) {
            return;
          }
          fetch(itensUrl, { headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(function (response) {
              return response
                .json()
                .then(function (data) {
                  return { ok: response.ok, data: data };
                })
                .catch(function () {
                  return { ok: response.ok, data: null };
                });
            })
            .then(function (result) {
              if (!result.ok || !result.data || !result.data.ok) {
                return;
              }
              if (form && typeof form._setEntregaItems === "function") {
                form._setEntregaItems(result.data.items || []);
              }
            })
            .catch(function () {});
        });
      }

      function bindEntregaCancel() {
        var triggers = document.querySelectorAll(".js-entrega-cancel-trigger");
        triggers.forEach(function (trigger) {
          trigger.addEventListener("click", function () {
            var formId = trigger.getAttribute("data-form-id");
            var confirmBtn = document.getElementById("entrega-cancel-confirm");
            if (!confirmBtn) {
              return;
            }
            confirmBtn.setAttribute("data-form-id", formId || "");
            var modalEl = document.getElementById("entregaCancelModal");
            if (!modalEl) {
              return;
            }
            var bodyEl = modalEl.querySelector(".modal-body");
            if (!bodyEl) {
              return;
            }
            var nome = trigger.getAttribute("data-nome") || "entrega";
            var messageEl = bodyEl.querySelector(".mb-2");
            if (messageEl) {
              messageEl.textContent = "Deseja cancelar a entrega " + nome + "?";
            }
            var motivoField = modalEl.querySelector("#entrega-cancel-motivo");
            if (motivoField) {
              motivoField.value = "";
            }
            var errorEl = modalEl.querySelector("[data-entrega-cancel-error]");
            if (errorEl) {
              errorEl.textContent = "";
              errorEl.classList.add("d-none");
            }
          });
        });

        var confirmBtn = document.getElementById("entrega-cancel-confirm");
        if (confirmBtn && !confirmBtn.dataset.bound) {
          confirmBtn.dataset.bound = "1";
          confirmBtn.addEventListener("click", function () {
            var formId = confirmBtn.getAttribute("data-form-id");
            if (!formId) {
              return;
            }
            var form = document.getElementById(formId);
            if (!form) {
              return;
            }
            var modalEl = document.getElementById("entregaCancelModal");
            if (modalEl && window.bootstrap) {
              var motivoField = modalEl.querySelector("#entrega-cancel-motivo");
              var motivo = motivoField ? motivoField.value.trim() : "";
              var errorEl = modalEl.querySelector("[data-entrega-cancel-error]");
              if (!motivo) {
                if (errorEl) {
                  errorEl.textContent = "Informe o motivo do cancelamento.";
                  errorEl.classList.remove("d-none");
                }
                return;
              }
              bootstrap.Modal.getInstance(modalEl).hide();
            }
            var formData = new FormData(form);
            var motivoField = modalEl ? modalEl.querySelector("#entrega-cancel-motivo") : null;
            if (motivoField) {
              formData.set("motivo_cancelamento", motivoField.value.trim());
            }
            fetch(form.action, {
              method: "POST",
              body: formData,
              headers: { "X-Requested-With": "XMLHttpRequest" },
            })
              .then(function (response) {
                return response
                  .json()
                  .then(function (data) {
                    return { ok: response.ok, data: data };
                  })
                  .catch(function () {
                    return { ok: response.ok, data: null };
                  });
              })
              .then(function (result) {
                if (!result.ok || !result.data || !result.data.ok) {
                  var errorEl = modalEl ? modalEl.querySelector("[data-entrega-cancel-error]") : null;
                  if (errorEl && result.data && result.data.message) {
                    errorEl.textContent = result.data.message;
                    errorEl.classList.remove("d-none");
                    return;
                  }
                  form.submit();
                  return;
                }
                var row = document.getElementById("entrega-row-" + result.data.row_id);
                if (row && result.data.row_html) {
                  row.outerHTML = result.data.row_html;
                }
                if (result.data.motivo_cancelamento) {
                  var updatedRow = document.getElementById("entrega-row-" + result.data.row_id);
                  if (updatedRow) {
                    var motivoTrigger = updatedRow.querySelector(".js-entrega-motivo-trigger");
                    if (motivoTrigger) {
                      motivoTrigger.setAttribute("data-motivo", result.data.motivo_cancelamento);
                    }
                  }
                }
                if (window.bindEntregaCancel) {
                  window.bindEntregaCancel();
                }
                if (window.bindEntregaMotivo) {
                  window.bindEntregaMotivo();
                }
              })
              .catch(function () {
                form.submit();
              });
          });
        }
      }

      window.bindEntregaCancel = bindEntregaCancel;

      function bindEntregaMotivo() {
        var triggers = document.querySelectorAll(".js-entrega-motivo-trigger");
        triggers.forEach(function (trigger) {
          trigger.addEventListener("click", function () {
            var modalEl = document.getElementById("entregaMotivoModal");
            var bodyEl = modalEl ? modalEl.querySelector("[data-entrega-motivo-body]") : null;
            if (!bodyEl) {
              return;
            }
            var motivo = trigger.getAttribute("data-motivo") || "";
            bodyEl.textContent = motivo || "Sem motivo informado.";
          });
        });
      }

      function bindEntregaFilters() {
        var filtersContainer = document.querySelector("[data-entrega-filters]");
        if (!filtersContainer) {
          return;
        }
        var form = filtersContainer.querySelector("form");
        var clearLink = filtersContainer.querySelector("a.btn-link");
        if (!form) {
          return;
        }
        form.addEventListener("submit", function (event) {
          event.preventDefault();
          var formData = new FormData(form);
          var params = new URLSearchParams(formData);
          var url = "?" + params.toString();
          fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
            .then(function (response) {
              return response.text();
            })
            .then(function (html) {
              updateEntregaTable(html);
            })
            .catch(function () {
              form.submit();
            });
        });

        if (clearLink) {
          clearLink.addEventListener("click", function (event) {
            event.preventDefault();
            if (form.reset) {
              form.reset();
            }
            fetch(clearLink.getAttribute("href") || "?", {
              headers: { "X-Requested-With": "XMLHttpRequest" },
            })
              .then(function (response) {
                return response.text();
              })
              .then(function (html) {
                updateEntregaTable(html);
              })
              .catch(function () {
                window.location.href = clearLink.getAttribute("href") || "?";
              });
          });
        }
      }

      function bindEntregaPagination() {
        var pagination = document.querySelector("[data-entrega-pagination]");
        if (!pagination) {
          return;
        }
        var links = pagination.querySelectorAll("a.page-link");
        links.forEach(function (link) {
          link.addEventListener("click", function (event) {
            event.preventDefault();
            var url = link.getAttribute("href");
            if (!url) {
              return;
            }
            fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
              .then(function (response) {
                return response.text();
              })
              .then(function (html) {
                updateEntregaTable(html);
              })
              .catch(function () {
                window.location.href = url;
              });
          });
        });
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", function () {
          initEntregaForms();
          bindEntregaFilters();
          bindEntregaPagination();
          bindEntregaConfirm();
          bindEntregaValidacaoConfirm();
          bindEntregaCancel();
          bindEntregaDetail();
          bindDevolucaoModal();
          bindEntregaDevolucao();
          bindEntregaMotivo();
          bindEntregaSolicitar();
          bindEntregaAtender();
          bindEntregaModalReset();
        });
      } else {
        initEntregaForms();
        bindEntregaFilters();
        bindEntregaPagination();
        bindEntregaConfirm();
        bindEntregaValidacaoConfirm();
        bindEntregaCancel();
        bindEntregaDetail();
        bindDevolucaoModal();
        bindEntregaDevolucao();
        bindEntregaMotivo();
        bindEntregaSolicitar();
        bindEntregaAtender();
        bindEntregaModalReset();
      }
    })();
  </script>
{% endblock %}
