{% extends "layout/base.html" %}

{% block title %}Importar CA{% endblock %}

{% block content %}
  {% include "components/_alerts.html" %}
  {% include "components/_page_header.html" with title=title %}

  <div class="card mb-3">
    <div class="card-body">
      <div class="fw-semibold">Buscar por Certificado de Aprovacao (CA)</div>
      <div class="text-muted small mb-3">
        Pesquise um CA para visualizar os dados disponiveis. Selecione um item abaixo para
        importa-lo e manter os dados sempre atualizados.
      </div>
      <div class="alert alert-warning mb-3 {% if not searched or csv_found %}d-none{% endif %}" data-ca-data-warning>
        Base de CA no schema public ainda nao foi carregada.
      </div>
      <form method="get" class="row g-3" id="ca-import-form" data-ca-api-url="{% url 'produtos:ca_import_api' %}" data-ca-fabricante-url="{% url 'produtos:ca_import_fabricante' %}">
        <div class="col-12 col-md-3">
          <label class="form-label">CA</label>
          <input type="text" class="form-control" name="ca" value="{{ ca_value }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Descricao</label>
          <input type="text" class="form-control" name="descricao" value="{{ descricao_value }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Fabricante</label>
          <input type="text" class="form-control" name="fabricante" value="{{ fabricante_value }}">
        </div>
        <div class="col-12 col-md-3 d-flex align-items-center">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="validos" value="1" id="validosCheck" checked>
            <label class="form-check-label" for="validosCheck">Somente CA validos</label>
          </div>
        </div>
        <input type="hidden" name="buscar" value="1">
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary btn-sm" type="submit" data-ca-search-btn>Buscar</button>
          <a class="btn btn-outline-secondary btn-sm" href="{% url 'produtos:ca_import' %}">Limpar</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      var form = document.getElementById("ca-import-form");
      if (!form) {
        return;
      }
      var button = form.querySelector("[data-ca-search-btn]");
      var inputs = form.querySelectorAll("input[name='ca'], input[name='descricao'], input[name='fabricante']");
      function hasQuery() {
        return Array.from(inputs).some(function (input) {
          return (input.value || "").trim().length > 0;
        });
      }
      function toggleButton() {
        var enabled = hasQuery();
        if (button) {
          button.disabled = !enabled;
        }
      }
      inputs.forEach(function (input) {
        input.addEventListener("input", toggleButton);
      });
      form.addEventListener("submit", function (event) {
        if (!hasQuery()) {
          event.preventDefault();
        }
      });
      toggleButton();
    })();
  </script>

  <div class="card mb-3 {% if not results %}d-none{% endif %}" data-ca-results-card>
      <div class="card-header">
        <div class="clarus-section-title mb-0">Resultados</div>
        <div class="text-muted small">Selecione um item para ver os detalhes.</div>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Produto</th>
              <th>Descricao</th>
        <th>Fabricante</th>
              <th>CA</th>
              <th>Vencimento</th>
              <th></th>
            </tr>
          </thead>
          <tbody data-ca-results>
            {% include "produtos/_ca_import_rows.html" with results=results somente_validos=somente_validos %}
          </tbody>
        </table>
      </div>
      <div class="p-2 text-center text-muted small d-none" data-ca-loading>Carregando...</div>
      <div class="p-2 text-center text-muted small d-none" data-ca-end>Sem mais resultados.</div>
    </div>

  <div class="alert alert-warning {% if not searched or not ca_value or results %}d-none{% endif %}" data-ca-empty>
    Nenhum item encontrado para o CA informado.
  </div>

  <div data-ca-selected>
    {% include "produtos/_ca_import_selected.html" with selected=selected %}
  </div>

  {% include "produtos/_produto_modal_form.html" with modal_id="createModal" modal_label_id="createModalLabel" modal_title="Novo produto" form=create_form form_action=create_produto_url prefix="create" fornecedores=None anexos=None %}

  <script>
    (function () {
      var form = document.getElementById("ca-import-form");
      var container = document.querySelector("[data-ca-results]");
      var resultsCard = document.querySelector("[data-ca-results-card]");
      var selectedContainer = document.querySelector("[data-ca-selected]");
      var emptyAlert = document.querySelector("[data-ca-empty]");
      var dataWarning = document.querySelector("[data-ca-data-warning]");
      var loading = document.querySelector("[data-ca-loading]");
      var endNotice = document.querySelector("[data-ca-end]");
      if (!form || !container) {
        return;
      }
      var apiUrl = form.getAttribute("data-ca-api-url");
      var fabricanteUrl = form.getAttribute("data-ca-fabricante-url");
      var hasMore = {{ has_more|yesno:"true,false" }};
      var offset = {{ next_offset|default:0 }};
      var isLoading = false;

      function buildParams(nextOffset) {
        var data = new FormData(form);
        var params = new URLSearchParams();
        data.forEach(function (value, key) {
          if (value !== null && value !== "") {
            params.append(key, value);
          }
        });
        params.set("offset", String(nextOffset || 0));
        params.set("render", "1");
        return params;
      }

      function hasQuery() {
        return Array.from(form.querySelectorAll("input[name='ca'], input[name='descricao'], input[name='fabricante']"))
          .some(function (input) {
            return (input.value || "").trim().length > 0;
          });
      }

      function applyResponse(data, replace) {
        if (!data || !data.ok) {
          return;
        }
        if (dataWarning) {
          dataWarning.classList.toggle("d-none", Boolean(data.data_found));
        }
        if (replace) {
          container.innerHTML = data.rows_html || "";
        } else if (data.rows_html) {
          container.insertAdjacentHTML("beforeend", data.rows_html);
        }
        if (resultsCard) {
          resultsCard.classList.toggle("d-none", !(data.rows_html && data.rows_html.trim().length));
        }
        if (selectedContainer) {
          selectedContainer.innerHTML = data.selected_html || "";
        }
        if (emptyAlert) {
          emptyAlert.classList.toggle("d-none", !(data.searched_ca && !data.has_results));
        }
        hasMore = Boolean(data.has_more);
        offset = data.next_offset || offset;
        if (!hasMore && endNotice) {
          endNotice.classList.remove("d-none");
        }
      }

      function fetchResults(nextOffset, replace) {
        if (!apiUrl || isLoading) {
          return;
        }
        isLoading = true;
        if (loading) {
          loading.classList.remove("d-none");
        }
        if (replace && endNotice) {
          endNotice.classList.add("d-none");
        }
        fetch(apiUrl + "?" + buildParams(nextOffset).toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } })
          .then(function (response) { return response.json(); })
          .then(function (data) { applyResponse(data, replace); })
          .catch(function () {})
          .finally(function () {
            isLoading = false;
            if (loading) {
              loading.classList.add("d-none");
            }
          });
      }

      function loadMore() {
        if (!hasMore || isLoading || !hasQuery()) {
          return;
        }
        fetchResults(offset, false);
      }

      form.addEventListener("submit", function (event) {
        event.preventDefault();
        if (!hasQuery()) {
          return;
        }
        offset = 0;
        hasMore = false;
        fetchResults(0, true);
      });

      var sentinel = document.createElement("div");
      container.parentElement.appendChild(sentinel);
      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            loadMore();
          }
        });
      });
      observer.observe(sentinel);
    })();
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var form = document.getElementById("ca-import-form");
      var modalEl = document.getElementById("createModal");
      if (!modalEl) {
        return;
      }
      var fabricanteUrl = form ? form.getAttribute("data-ca-fabricante-url") : "";

      var successAlert = document.querySelector("[data-ca-import-success]");

      function initProdutoModal(modal) {
        if (!modal || modal.dataset.bound === "1") {
          return;
        }
        modal.dataset.bound = "1";

        var caInput = modal.querySelector("input[name='ca']");
        var vencimentoInput = modal.querySelector("input[name='data_vencimento_ca']");
        var caStatusBadge = modal.querySelector("[data-ca-status]");
        var caStatusText = modal.querySelector("[data-ca-status-text]");
        var tabsNav = modal.querySelector("[data-produto-tabs]");

        function showTabForElement(element) {
          if (!element || !tabsNav || !window.bootstrap) {
            return null;
          }
          var pane = element.closest(".tab-pane");
          if (!pane || !pane.id) {
            return null;
          }
          var tabButton = tabsNav.querySelector("[data-bs-target='#" + pane.id + "']");
          if (!tabButton) {
            return null;
          }
          var tabInstance = bootstrap.Tab.getOrCreateInstance(tabButton);
          tabInstance.show();
          return { pane: pane, tabButton: tabButton };
        }

        function showToast(message, level) {
          if (window.clarusToast) {
            window.clarusToast(message, level || "danger");
          }
        }

        function markInvalidFields(fields) {
          (fields || []).forEach(function (field) {
            if (!field) return;
            if (field.classList) {
              field.classList.add("is-invalid");
            }
            if (field.tagName === "SELECT" && field._choicesInstance && field._choicesInstance.containerOuter) {
              var wrapper = field._choicesInstance.containerOuter.element;
              if (wrapper) {
                wrapper.classList.add("is-invalid");
              }
            }
            if (field.type === "radio") {
              var wrap = field.closest(".mb-3") || field.closest(".form-check") || field.parentElement;
              if (wrap && wrap.classList) {
                wrap.classList.add("is-invalid");
              }
            }
          });
        }

        function focusFirstError() {
          var error = modal.querySelector(".invalid-feedback.d-block");
          if (!error) {
            return;
          }
          showTabForElement(error);
          error.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        function setCaStatus(kind, text) {
          if (!caStatusBadge) {
            return;
          }
          caStatusBadge.classList.add("d-none");
          caStatusBadge.classList.remove(
            "text-bg-success",
            "text-bg-danger",
            "text-bg-secondary",
            "text-bg-warning",
            "text-dark"
          );
          caStatusBadge.textContent = "";
          if (caStatusText) {
            caStatusText.classList.add("d-none");
            caStatusText.textContent = "";
          }
          if (!kind) {
            return;
          }
          caStatusBadge.classList.remove("d-none");
          if (kind === "valid") {
            caStatusBadge.classList.add("text-bg-success");
            caStatusBadge.textContent = "Valido";
          } else if (kind === "expired") {
            caStatusBadge.classList.add("text-bg-danger");
            caStatusBadge.textContent = "Vencido";
          } else if (kind === "not_found") {
            caStatusBadge.classList.add("text-bg-secondary");
            caStatusBadge.textContent = "Nao encontrado";
          } else {
            caStatusBadge.classList.add("text-bg-warning", "text-dark");
            caStatusBadge.textContent = "Indisponivel";
          }
          if (text && caStatusText) {
            caStatusText.classList.remove("d-none");
            caStatusText.textContent = text;
          }
        }

        function fetchCaStatus(ca) {
          if (!caStatusBadge) {
            return Promise.resolve(null);
          }
          var url = caStatusBadge.getAttribute("data-ca-status-url") || "";
          if (!url) {
            return Promise.resolve(null);
          }
          return fetch(url + "?ca=" + encodeURIComponent(ca), {
            headers: { "X-Requested-With": "XMLHttpRequest" },
          })
            .then(function (response) {
              return response.json();
            })
            .then(function (data) {
              return data && data.ok ? data : null;
            })
            .catch(function () {
              return null;
            });
        }

        function ensureCaValid() {
          if (!caInput) {
            return Promise.resolve(true);
          }
          var ca = (caInput.value || "").trim();
          if (!ca) {
            setCaStatus(null, "");
            caInput.setCustomValidity("");
            caInput.classList.remove("is-invalid", "is-valid");
            if (vencimentoInput) {
              // Mantem valor manual se usuario ja informou.
            }
            return Promise.resolve(true);
          }
          if (caInput.dataset.checkedValue === ca && caInput.dataset.caStatus) {
            return Promise.resolve(caInput.dataset.caStatus === "valid");
          }
          setCaStatus("unknown", "Validando...");
          return fetchCaStatus(ca).then(function (result) {
            caInput.dataset.checkedValue = ca;
            caInput.dataset.caStatus = result ? result.status || "" : "";
            if (!result) {
              setCaStatus("unknown", "Falha ao consultar base de CAs.");
              caInput.setCustomValidity("");
              caInput.classList.remove("is-invalid");
              return true;
            }
            if (vencimentoInput && result.data_validade && !(vencimentoInput.value || "").trim()) {
              vencimentoInput.value = result.data_validade;
            }
            if (result.status === "valid") {
              setCaStatus("valid", "Vence em " + (result.data_validade_display || "-"));
              caInput.setCustomValidity("");
              caInput.classList.remove("is-invalid");
              caInput.classList.add("is-valid");
              return true;
            }
            if (result.status === "expired") {
              setCaStatus("expired", "Venceu em " + (result.data_validade_display || "-"));
              caInput.setCustomValidity("CA vencido.");
              caInput.classList.remove("is-valid");
              caInput.classList.add("is-invalid");
              return false;
            }
            if (result.status === "not_found") {
              setCaStatus("not_found", "Nao encontrado no schema public.");
              caInput.setCustomValidity("");
              caInput.classList.remove("is-invalid", "is-valid");
              return true;
            }
            setCaStatus("unknown", "Sem validade na base.");
            caInput.setCustomValidity("");
            caInput.classList.remove("is-invalid", "is-valid");
            return true;
          });
        }

        var fabricanteSelect = modal.querySelector("select[name='fabricante']");
        var fabricanteDisplay = modal.querySelector("[data-fabricante-display]");
        function syncFabricanteDisplay() {
          if (!fabricanteDisplay) {
            return;
          }
          if (!fabricanteSelect) {
            return;
          }
          var selectedOption = fabricanteSelect.options[fabricanteSelect.selectedIndex];
          fabricanteDisplay.value = selectedOption ? selectedOption.text : "";
        }
        if (fabricanteSelect && fabricanteDisplay) {
          fabricanteSelect.addEventListener("change", syncFabricanteDisplay);
          syncFabricanteDisplay();
        }

        if (caInput) {
          var caTimer = null;
          caInput.addEventListener("input", function () {
            if (caTimer) {
              clearTimeout(caTimer);
            }
            caTimer = setTimeout(function () {
              ensureCaValid();
            }, 400);
          });
          caInput.addEventListener("blur", function () {
            ensureCaValid();
          });
          if ((caInput.value || "").trim()) {
            ensureCaValid();
          }
        }

        var addButton = modal.querySelector("[data-fornecedor-add]");
        var rowsContainer = modal.querySelector("[data-fornecedor-rows]");
        var template = modal.querySelector("[data-fornecedor-template]");
        var addAnexoButton = modal.querySelector("[data-anexo-add]");
        var anexosContainer = modal.querySelector("[data-anexo-rows]");
        var anexoTemplate = modal.querySelector("[data-anexo-template]");

        function syncRowIndices() {
          if (!rowsContainer) {
            return;
          }
          var rows = rowsContainer.querySelectorAll("[data-fornecedor-row]");
          rows.forEach(function (row, index) {
            row.dataset.index = String(index);
            var fields = row.querySelectorAll("[data-field]");
            fields.forEach(function (field) {
              var baseName = field.getAttribute("name") || "";
              if (baseName.indexOf("__index__") !== -1) {
                field.name = baseName.replace("__index__", String(index));
              } else {
                field.name = "fornecedores[" + index + "][" + field.dataset.field + "]";
              }
            });
            var removeButton = row.querySelector("[data-fornecedor-remove]");
            if (removeButton) {
              removeButton.disabled = rows.length === 1;
            }
          });
        }

        function addRow() {
          if (!template || !rowsContainer) {
            return null;
          }
          var fragment = document.importNode(template.content, true);
          rowsContainer.appendChild(fragment);
          syncRowIndices();
          return rowsContainer.querySelector("[data-fornecedor-row]:last-child");
        }

        if (addButton) {
          addButton.addEventListener("click", function () {
            addRow();
          });
        }

        if (rowsContainer) {
          rowsContainer.addEventListener("click", function (event) {
            var removeButton = event.target.closest("[data-fornecedor-remove]");
            if (!removeButton) {
              return;
            }
            var row = removeButton.closest("[data-fornecedor-row]");
            if (row) {
              row.remove();
              syncRowIndices();
            }
          });
          if (!rowsContainer.querySelector("[data-fornecedor-row]")) {
            addRow();
          } else {
            syncRowIndices();
          }
        }

        function syncAnexoIndices() {
          if (!anexosContainer) {
            return;
          }
          var rows = anexosContainer.querySelectorAll("[data-anexo-row]");
          rows.forEach(function (row, index) {
            row.dataset.index = String(index);
            var fields = row.querySelectorAll("[data-field]");
            fields.forEach(function (field) {
              field.name = "anexos[" + index + "][" + field.dataset.field + "]";
            });
          });
        }

        function addAnexoRow() {
          if (!anexoTemplate || !anexosContainer) {
            return;
          }
          var fragment = document.importNode(anexoTemplate.content, true);
          anexosContainer.appendChild(fragment);
          syncAnexoIndices();
        }

        if (addAnexoButton) {
          addAnexoButton.addEventListener("click", function () {
            addAnexoRow();
          });
        }

        if (anexosContainer) {
          anexosContainer.addEventListener("click", function (event) {
            var removeButton = event.target.closest("[data-anexo-remove]");
            if (!removeButton) {
              return;
            }
            var row = removeButton.closest("[data-anexo-row]");
            if (row) {
              row.remove();
              syncAnexoIndices();
            }
          });
          if (!anexosContainer.querySelector("[data-anexo-row]")) {
            addAnexoRow();
          } else {
            syncAnexoIndices();
          }
        }

        var tabsNav = modal.querySelector("[data-produto-tabs]");
        var tabButtons = tabsNav ? tabsNav.querySelectorAll(".nav-link") : [];
        var shouldLockTabs = modal.dataset.tabsLock === "1";

        function setTabLocked(tabButton, locked) {
          tabButton.dataset.unlocked = locked ? "0" : "1";
          tabButton.disabled = locked;
          tabButton.setAttribute("aria-disabled", locked ? "true" : "false");
          tabButton.tabIndex = locked ? -1 : 0;
        }

        tabButtons.forEach(function (button, index) {
          if (shouldLockTabs) {
            setTabLocked(button, index !== 0);
          } else {
            setTabLocked(button, false);
          }
          button.addEventListener("show.bs.tab", function (event) {
            if (shouldLockTabs && button.dataset.unlocked !== "1") {
              event.preventDefault();
            }
          });
        });

        function unlockTab(targetSelector) {
          if (!tabsNav) {
            return;
          }
          var targetButton = tabsNav.querySelector("[data-bs-target='" + targetSelector + "']");
          if (targetButton) {
            setTabLocked(targetButton, false);
          }
        }

        function validateTab(tabPane) {
          if (!tabPane) {
            return true;
          }
          var helper = window.clarusRequiredValidation;
          var invalid = helper && helper.collectInvalidRequired ? helper.collectInvalidRequired(tabPane) : [];
          if (!invalid.length) {
            return true;
          }
          markInvalidFields(invalid);
          var first = invalid[0];
          showTabForElement(first);
          showToast(helper && helper.buildMessage ? helper.buildMessage(invalid) : "Preencha os campos obrigatorios.", "danger");
          try {
            first.focus({ preventScroll: true });
          } catch (e) {}
          try {
            first.scrollIntoView({ block: "center", behavior: "smooth" });
          } catch (e) {}
          return false;
        }

        modal.querySelectorAll("[data-tab-next]").forEach(function (button) {
          button.addEventListener("click", function () {
            var currentPane = button.closest(".tab-pane");
            if (!currentPane) {
              return;
            }
            if (!validateTab(currentPane)) {
              return;
            }
            var targetSelector = button.getAttribute("data-tab-next");
            var targetPane = modal.querySelector(targetSelector);
            if (!targetPane) {
              return;
            }
            if (shouldLockTabs) {
              unlockTab(targetSelector);
            }
            var targetTabButton = tabsNav ? tabsNav.querySelector("[data-bs-target='" + targetSelector + "']") : null;
            if (targetTabButton && window.bootstrap) {
              var tabInstance = bootstrap.Tab.getOrCreateInstance(targetTabButton);
              tabInstance.show();
            }
          });
        });

        modal.querySelectorAll("[data-tab-prev]").forEach(function (button) {
          button.addEventListener("click", function () {
            var targetSelector = button.getAttribute("data-tab-prev");
            if (shouldLockTabs) {
              unlockTab(targetSelector);
            }
            var targetTabButton = tabsNav ? tabsNav.querySelector("[data-bs-target='" + targetSelector + "']") : null;
            if (targetTabButton && window.bootstrap) {
              var tabInstance = bootstrap.Tab.getOrCreateInstance(targetTabButton);
              tabInstance.show();
            }
          });
        });

        var form = modal.querySelector("form");
        if (form && !form.dataset.bound) {
          form.dataset.bound = "1";
          form.addEventListener("submit", function (event) {
            event.preventDefault();

            var helper = window.clarusRequiredValidation;
            if (helper && helper.collectInvalidRequired) {
              var invalid = helper.collectInvalidRequired(form);
              if (invalid.length) {
                markInvalidFields(invalid);
                var first = invalid[0];
                showTabForElement(first);
                showToast(helper.buildMessage ? helper.buildMessage(invalid) : "Preencha os campos obrigatorios.", "danger");
                try {
                  first.focus({ preventScroll: true });
                } catch (e) {}
                try {
                  first.scrollIntoView({ block: "center", behavior: "smooth" });
                } catch (e) {}
                return;
              }
            }

            if (caInput && !caInput.checkValidity()) {
              showTabForElement(caInput);
              showToast("Verifique o CA antes de salvar.", "warning");
              return;
            }
            if (rowsContainer) {
              syncRowIndices();
            }
            ensureCaValid().then(function (valid) {
              if (!valid) {
                if (caInput) {
                  showTabForElement(caInput);
                  showToast("CA vencido. Nao e possivel salvar.");
                }
                return;
              }
              var formData = new FormData(form);
              fetch(form.action, {
                method: "POST",
                body: formData,
                headers: { "X-Requested-With": "XMLHttpRequest" },
              })
                .then(function (response) {
                  return response
                    .json()
                    .then(function (data) {
                      return { ok: response.ok, data: data };
                    })
                    .catch(function () {
                      return { ok: response.ok, data: null };
                    });
                })
                .then(function (result) {
                  if (!result.ok || !result.data || !result.data.ok) {
                    if (result.data && result.data.form_html) {
                      var parser = new DOMParser();
                      var doc = parser.parseFromString(result.data.form_html, "text/html");
                      var newModal = doc.querySelector("[data-produto-modal]");
                      var newBody = newModal ? newModal.querySelector(".modal-body") : null;
                      var currentBody = modal.querySelector(".modal-body");
                      if (newBody && currentBody) {
                        currentBody.innerHTML = newBody.innerHTML;
                        modal.dataset.bound = "0";
                        initProdutoModal(modal);
                        focusFirstError();
                      }
                    }
                    return;
                  }

                  showToast("Salvo com sucesso.", "success");
                  if (window.bootstrap) {
                    var modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                      modalInstance.hide();
                    }
                  }
                  if (successAlert) {
                    successAlert.classList.remove("d-none");
                    successAlert.scrollIntoView({ behavior: "smooth", block: "start" });
                  }
                })
                .catch(function () {
                  form.submit();
                });
            });
          });
        }
      }

      function fillProdutoModal(modal, data) {
        if (!modal || !data) {
          return;
        }
        var form = modal.querySelector("form");
        if (form && form.reset) {
          form.reset();
        }
        var nomeInput = modal.querySelector("input[name='nome']");
        var referenciaInput = modal.querySelector("input[name='referencia']");
        var caInput = modal.querySelector("input[name='ca']");
        var validadeInput = modal.querySelector("input[name='data_vencimento_ca']");
        var controleEpiInput = modal.querySelector("input[name='controle_epi']");
        var fabricanteSelect = modal.querySelector("select[name='fabricante']");
        var fabricanteDisplay = modal.querySelector("[data-fabricante-display]");
        if (nomeInput && data.nome) {
          nomeInput.value = data.nome;
        }
        if (referenciaInput && data.referencia) {
          referenciaInput.value = data.referencia;
        }
        if (caInput && data.ca) {
          caInput.value = data.ca;
        }
        if (validadeInput && data.dataVencimentoCa) {
          validadeInput.value = data.dataVencimentoCa;
        }
        if (controleEpiInput) {
          controleEpiInput.checked = Boolean(data.ca || data.dataVencimentoCa || data.fabricanteId || data.fabricanteNome);
        }

        if (fabricanteSelect && data.fabricanteId) {
          var existing = Array.from(fabricanteSelect.options).find(function (option) {
            return String(option.value) === String(data.fabricanteId);
          });
          if (!existing && data.fabricanteNome) {
            var newOption = document.createElement("option");
            newOption.value = String(data.fabricanteId);
            newOption.textContent = data.fabricanteNome;
            fabricanteSelect.appendChild(newOption);
          }
          fabricanteSelect.value = String(data.fabricanteId);
          if (fabricanteDisplay) {
            fabricanteDisplay.value = data.fabricanteNome || "";
          }
        }

        if (window.clarusChoices && window.clarusChoices.refresh) {
          modal.querySelectorAll("select").forEach(function (selectEl) {
            window.clarusChoices.refresh(selectEl);
          });
        }

        var firstTab = modal.querySelector("[data-produto-tabs] .nav-link");
        if (firstTab && window.bootstrap) {
          var tabInstance = bootstrap.Tab.getOrCreateInstance(firstTab);
          tabInstance.show();
        }
      }

      initProdutoModal(modalEl);

      document.addEventListener("click", function (event) {
        var trigger = event.target.closest("[data-ca-import-button]");
        if (!trigger) {
          return;
        }
        event.preventDefault();
        if (successAlert) {
          successAlert.classList.add("d-none");
        }
        var payload = {
          nome: trigger.getAttribute("data-ca-nome") || "",
          referencia: trigger.getAttribute("data-ca-referencia") || "",
          fabricante: trigger.getAttribute("data-ca-fabricante") || "",
          fabricanteCnpj: trigger.getAttribute("data-ca-cnpj") || "",
          ca: trigger.getAttribute("data-ca-registro") || "",
          dataVencimentoCa: trigger.getAttribute("data-ca-validade") || "",
        };

        function openModal() {
          if (window.bootstrap) {
            var instance = bootstrap.Modal.getOrCreateInstance(modalEl);
            instance.show();
          }
        }

        function getCookie(name) {
          var value = "; " + document.cookie;
          var parts = value.split("; " + name + "=");
          if (parts.length === 2) {
            return parts.pop().split(";").shift();
          }
          return "";
        }

        function ensureFabricante(nome, cnpj) {
          if (!fabricanteUrl || !nome) {
            return Promise.resolve(null);
          }
          var body = new URLSearchParams();
          body.set("nome", nome);
          if (cnpj) {
            body.set("cnpj", cnpj);
          }
          return fetch(fabricanteUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": getCookie("csrftoken"),
              "X-Requested-With": "XMLHttpRequest",
            },
            body: body.toString(),
          })
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (data && data.ok) {
                return { id: data.id, nome: data.nome };
              }
              return null;
            })
            .catch(function () { return null; });
        }

        ensureFabricante(payload.fabricante, payload.fabricanteCnpj).then(function (fabricanteInfo) {
          if (fabricanteInfo) {
            payload.fabricanteId = fabricanteInfo.id;
            payload.fabricanteNome = fabricanteInfo.nome;
          }
          openModal();
          fillProdutoModal(modalEl, payload);
        });
      });
    });
  </script>
{% endblock %}
