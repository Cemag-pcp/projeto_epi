{% extends "layout/base.html" %}

{% block title %}Importar CA{% endblock %}

{% block content %}
  {% include "components/_alerts.html" %}
  {% include "components/_page_header.html" with title=title %}

  <div class="card mb-3">
    <div class="card-body">
      <div class="fw-semibold">Buscar por Certificado de Aprovacao (CA)</div>
      <div class="text-muted small mb-3">
        Pesquise um CA para visualizar os dados disponiveis. Selecione um item abaixo para
        importa-lo e manter os dados sempre atualizados.
      </div>
      <div class="alert alert-warning mb-3 {% if not searched or csv_found %}d-none{% endif %}" data-ca-data-warning>
        Base de CA no schema public ainda nao foi carregada.
      </div>
      <form method="get" class="row g-3" id="ca-import-form" data-ca-api-url="{% url 'produtos:ca_import_api' %}" data-ca-fornecedor-url="{% url 'produtos:ca_import_fornecedor' %}">
        <div class="col-12 col-md-3">
          <label class="form-label">CA</label>
          <input type="text" class="form-control" name="ca" value="{{ ca_value }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Descricao</label>
          <input type="text" class="form-control" name="descricao" value="{{ descricao_value }}">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Fornecedor</label>
          <input type="text" class="form-control" name="fornecedor" value="{{ fornecedor_value }}">
        </div>
        <div class="col-12 col-md-3 d-flex align-items-center">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="validos" value="1" id="validosCheck" {% if somente_validos %}checked{% endif %}>
            <label class="form-check-label" for="validosCheck">Somente CA validos</label>
          </div>
        </div>
        <input type="hidden" name="buscar" value="1">
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary btn-sm" type="submit" data-ca-search-btn>Buscar</button>
          <a class="btn btn-outline-secondary btn-sm" href="{% url 'produtos:ca_import' %}">Limpar</a>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      var form = document.getElementById("ca-import-form");
      if (!form) {
        return;
      }
      var button = form.querySelector("[data-ca-search-btn]");
      var inputs = form.querySelectorAll("input[name='ca'], input[name='descricao'], input[name='fornecedor']");
      function hasQuery() {
        return Array.from(inputs).some(function (input) {
          return (input.value || "").trim().length > 0;
        });
      }
      function toggleButton() {
        var enabled = hasQuery();
        if (button) {
          button.disabled = !enabled;
        }
      }
      inputs.forEach(function (input) {
        input.addEventListener("input", toggleButton);
      });
      form.addEventListener("submit", function (event) {
        if (!hasQuery()) {
          event.preventDefault();
        }
      });
      toggleButton();
    })();
  </script>

  <div class="card mb-3 {% if not results %}d-none{% endif %}" data-ca-results-card>
      <div class="card-header">
        <div class="clarus-section-title mb-0">Resultados</div>
        <div class="text-muted small">Selecione um item para ver os detalhes.</div>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Produto</th>
              <th>Descricao</th>
              <th>Fornecedor</th>
              <th>CA</th>
              <th>Vencimento</th>
              <th></th>
            </tr>
          </thead>
          <tbody data-ca-results>
            {% include "produtos/_ca_import_rows.html" with results=results somente_validos=somente_validos %}
          </tbody>
        </table>
      </div>
      <div class="p-2 text-center text-muted small d-none" data-ca-loading>Carregando...</div>
      <div class="p-2 text-center text-muted small d-none" data-ca-end>Sem mais resultados.</div>
    </div>

  <div class="alert alert-warning {% if not searched or not ca_value or results %}d-none{% endif %}" data-ca-empty>
    Nenhum item encontrado para o CA informado.
  </div>

  <div data-ca-selected>
    {% include "produtos/_ca_import_selected.html" with selected=selected %}
  </div>

  <div class="alert alert-success d-none" data-ca-import-success>Produto importado com sucesso.</div>

  {% include "produtos/_produto_modal_form.html" with modal_id="createModal" modal_label_id="createModalLabel" modal_title="Novo produto" form=create_form form_action=create_produto_url prefix="create" fornecedores=None anexos=None %}

  <script>
    (function () {
      var form = document.getElementById("ca-import-form");
      var container = document.querySelector("[data-ca-results]");
      var resultsCard = document.querySelector("[data-ca-results-card]");
      var selectedContainer = document.querySelector("[data-ca-selected]");
      var emptyAlert = document.querySelector("[data-ca-empty]");
      var dataWarning = document.querySelector("[data-ca-data-warning]");
      var loading = document.querySelector("[data-ca-loading]");
      var endNotice = document.querySelector("[data-ca-end]");
      if (!form || !container) {
        return;
      }
      var apiUrl = form.getAttribute("data-ca-api-url");
      var fornecedorUrl = form.getAttribute("data-ca-fornecedor-url");
      var hasMore = {{ has_more|yesno:"true,false" }};
      var offset = {{ next_offset|default:0 }};
      var isLoading = false;

      function buildParams(nextOffset) {
        var data = new FormData(form);
        var params = new URLSearchParams();
        data.forEach(function (value, key) {
          if (value !== null && value !== "") {
            params.append(key, value);
          }
        });
        params.set("offset", String(nextOffset || 0));
        params.set("render", "1");
        return params;
      }

      function hasQuery() {
        return Array.from(form.querySelectorAll("input[name='ca'], input[name='descricao'], input[name='fornecedor']"))
          .some(function (input) {
            return (input.value || "").trim().length > 0;
          });
      }

      function applyResponse(data, replace) {
        if (!data || !data.ok) {
          return;
        }
        if (dataWarning) {
          dataWarning.classList.toggle("d-none", Boolean(data.data_found));
        }
        if (replace) {
          container.innerHTML = data.rows_html || "";
        } else if (data.rows_html) {
          container.insertAdjacentHTML("beforeend", data.rows_html);
        }
        if (resultsCard) {
          resultsCard.classList.toggle("d-none", !(data.rows_html && data.rows_html.trim().length));
        }
        if (selectedContainer) {
          selectedContainer.innerHTML = data.selected_html || "";
        }
        if (emptyAlert) {
          emptyAlert.classList.toggle("d-none", !(data.searched_ca && !data.has_results));
        }
        hasMore = Boolean(data.has_more);
        offset = data.next_offset || offset;
        if (!hasMore && endNotice) {
          endNotice.classList.remove("d-none");
        }
      }

      function fetchResults(nextOffset, replace) {
        if (!apiUrl || isLoading) {
          return;
        }
        isLoading = true;
        if (loading) {
          loading.classList.remove("d-none");
        }
        if (replace && endNotice) {
          endNotice.classList.add("d-none");
        }
        fetch(apiUrl + "?" + buildParams(nextOffset).toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } })
          .then(function (response) { return response.json(); })
          .then(function (data) { applyResponse(data, replace); })
          .catch(function () {})
          .finally(function () {
            isLoading = false;
            if (loading) {
              loading.classList.add("d-none");
            }
          });
      }

      function loadMore() {
        if (!hasMore || isLoading || !hasQuery()) {
          return;
        }
        fetchResults(offset, false);
      }

      form.addEventListener("submit", function (event) {
        event.preventDefault();
        if (!hasQuery()) {
          return;
        }
        offset = 0;
        hasMore = false;
        fetchResults(0, true);
      });

      var sentinel = document.createElement("div");
      container.parentElement.appendChild(sentinel);
      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            loadMore();
          }
        });
      });
      observer.observe(sentinel);
    })();
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var form = document.getElementById("ca-import-form");
      var modalEl = document.getElementById("createModal");
      if (!modalEl) {
        return;
      }
      var fornecedorUrl = form ? form.getAttribute("data-ca-fornecedor-url") : "";

      var successAlert = document.querySelector("[data-ca-import-success]");

      function initProdutoModal(modal) {
        if (!modal || modal.dataset.bound === "1") {
          return;
        }
        modal.dataset.bound = "1";

        var addButton = modal.querySelector("[data-fornecedor-add]");
        var rowsContainer = modal.querySelector("[data-fornecedor-rows]");
        var template = modal.querySelector("[data-fornecedor-template]");
        var addAnexoButton = modal.querySelector("[data-anexo-add]");
        var anexosContainer = modal.querySelector("[data-anexo-rows]");
        var anexoTemplate = modal.querySelector("[data-anexo-template]");

        function syncRowIndices() {
          if (!rowsContainer) {
            return;
          }
          var rows = rowsContainer.querySelectorAll("[data-fornecedor-row]");
          rows.forEach(function (row, index) {
            row.dataset.index = String(index);
            var fields = row.querySelectorAll("[data-field]");
            fields.forEach(function (field) {
              field.name = "fornecedores[" + index + "][" + field.dataset.field + "]";
            });
            var removeButton = row.querySelector("[data-fornecedor-remove]");
            if (removeButton) {
              removeButton.disabled = rows.length === 1;
            }
          });
        }

        function addRow() {
          if (!template || !rowsContainer) {
            return null;
          }
          var fragment = document.importNode(template.content, true);
          rowsContainer.appendChild(fragment);
          syncRowIndices();
          return rowsContainer.querySelector("[data-fornecedor-row]:last-child");
        }

        if (addButton) {
          addButton.addEventListener("click", function () {
            addRow();
          });
        }

        if (rowsContainer) {
          rowsContainer.addEventListener("click", function (event) {
            var removeButton = event.target.closest("[data-fornecedor-remove]");
            if (!removeButton) {
              return;
            }
            var row = removeButton.closest("[data-fornecedor-row]");
            if (row) {
              row.remove();
              syncRowIndices();
            }
          });
          if (!rowsContainer.querySelector("[data-fornecedor-row]")) {
            addRow();
          } else {
            syncRowIndices();
          }
        }

        function syncAnexoIndices() {
          if (!anexosContainer) {
            return;
          }
          var rows = anexosContainer.querySelectorAll("[data-anexo-row]");
          rows.forEach(function (row, index) {
            row.dataset.index = String(index);
            var fields = row.querySelectorAll("[data-field]");
            fields.forEach(function (field) {
              field.name = "anexos[" + index + "][" + field.dataset.field + "]";
            });
          });
        }

        function addAnexoRow() {
          if (!anexoTemplate || !anexosContainer) {
            return;
          }
          var fragment = document.importNode(anexoTemplate.content, true);
          anexosContainer.appendChild(fragment);
          syncAnexoIndices();
        }

        if (addAnexoButton) {
          addAnexoButton.addEventListener("click", function () {
            addAnexoRow();
          });
        }

        if (anexosContainer) {
          anexosContainer.addEventListener("click", function (event) {
            var removeButton = event.target.closest("[data-anexo-remove]");
            if (!removeButton) {
              return;
            }
            var row = removeButton.closest("[data-anexo-row]");
            if (row) {
              row.remove();
              syncAnexoIndices();
            }
          });
          if (!anexosContainer.querySelector("[data-anexo-row]")) {
            addAnexoRow();
          } else {
            syncAnexoIndices();
          }
        }

        var tabsNav = modal.querySelector("[data-produto-tabs]");
        var tabButtons = tabsNav ? tabsNav.querySelectorAll(".nav-link") : [];
        var shouldLockTabs = modal.dataset.tabsLock === "1";

        function setTabLocked(tabButton, locked) {
          tabButton.dataset.unlocked = locked ? "0" : "1";
          tabButton.disabled = locked;
          tabButton.setAttribute("aria-disabled", locked ? "true" : "false");
          tabButton.tabIndex = locked ? -1 : 0;
        }

        tabButtons.forEach(function (button, index) {
          if (shouldLockTabs) {
            setTabLocked(button, index !== 0);
          } else {
            setTabLocked(button, false);
          }
          button.addEventListener("show.bs.tab", function (event) {
            if (shouldLockTabs && button.dataset.unlocked !== "1") {
              event.preventDefault();
            }
          });
        });

        function unlockTab(targetSelector) {
          if (!tabsNav) {
            return;
          }
          var targetButton = tabsNav.querySelector("[data-bs-target='" + targetSelector + "']");
          if (targetButton) {
            setTabLocked(targetButton, false);
          }
        }

        function validateTab(tabPane) {
          var fields = tabPane.querySelectorAll("input, select, textarea");
          for (var i = 0; i < fields.length; i++) {
            var field = fields[i];
            if (field.disabled) {
              continue;
            }
            if (!field.hasAttribute("required")) {
              continue;
            }
            if (!field.checkValidity()) {
              field.reportValidity();
              return false;
            }
          }
          return true;
        }

        modal.querySelectorAll("[data-tab-next]").forEach(function (button) {
          button.addEventListener("click", function () {
            var currentPane = button.closest(".tab-pane");
            if (!currentPane) {
              return;
            }
            if (!validateTab(currentPane)) {
              return;
            }
            var targetSelector = button.getAttribute("data-tab-next");
            var targetPane = modal.querySelector(targetSelector);
            if (!targetPane) {
              return;
            }
            if (shouldLockTabs) {
              unlockTab(targetSelector);
            }
            var targetTabButton = tabsNav ? tabsNav.querySelector("[data-bs-target='" + targetSelector + "']") : null;
            if (targetTabButton && window.bootstrap) {
              var tabInstance = bootstrap.Tab.getOrCreateInstance(targetTabButton);
              tabInstance.show();
            }
          });
        });

        modal.querySelectorAll("[data-tab-prev]").forEach(function (button) {
          button.addEventListener("click", function () {
            var targetSelector = button.getAttribute("data-tab-prev");
            if (shouldLockTabs) {
              unlockTab(targetSelector);
            }
            var targetTabButton = tabsNav ? tabsNav.querySelector("[data-bs-target='" + targetSelector + "']") : null;
            if (targetTabButton && window.bootstrap) {
              var tabInstance = bootstrap.Tab.getOrCreateInstance(targetTabButton);
              tabInstance.show();
            }
          });
        });

        var form = modal.querySelector("form");
        if (form && !form.dataset.bound) {
          form.dataset.bound = "1";
          form.addEventListener("submit", function (event) {
            event.preventDefault();
            var formData = new FormData(form);
            fetch(form.action, {
              method: "POST",
              body: formData,
              headers: { "X-Requested-With": "XMLHttpRequest" },
            })
              .then(function (response) {
                return response
                  .json()
                  .then(function (data) {
                    return { ok: response.ok, data: data };
                  })
                  .catch(function () {
                    return { ok: response.ok, data: null };
                  });
              })
              .then(function (result) {
                if (!result.ok || !result.data || !result.data.ok) {
                  if (result.data && result.data.form_html) {
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(result.data.form_html, "text/html");
                    var newModal = doc.querySelector("[data-produto-modal]");
                    var newBody = newModal ? newModal.querySelector(".modal-body") : null;
                    var currentBody = modal.querySelector(".modal-body");
                    if (newBody && currentBody) {
                      currentBody.innerHTML = newBody.innerHTML;
                      modal.dataset.bound = "0";
                      initProdutoModal(modal);
                    }
                  }
                  return;
                }
                if (window.bootstrap) {
                  var modalInstance = bootstrap.Modal.getInstance(modal);
                  if (modalInstance) {
                    modalInstance.hide();
                  }
                }
                if (successAlert) {
                  successAlert.classList.remove("d-none");
                  successAlert.scrollIntoView({ behavior: "smooth", block: "start" });
                }
              })
              .catch(function () {
                form.submit();
              });
          });
        }
      }

      function fillProdutoModal(modal, data) {
        if (!modal || !data) {
          return;
        }
        var form = modal.querySelector("form");
        if (form && form.reset) {
          form.reset();
        }
        var nomeInput = modal.querySelector("input[name='nome']");
        var referenciaInput = modal.querySelector("input[name='referencia']");
        if (nomeInput && data.nome) {
          nomeInput.value = data.nome;
        }
        if (referenciaInput && data.referencia) {
          referenciaInput.value = data.referencia;
        }

        var rowsContainer = modal.querySelector("[data-fornecedor-rows]");
        var addButton = modal.querySelector("[data-fornecedor-add]");
        var row = rowsContainer ? rowsContainer.querySelector("[data-fornecedor-row]") : null;
        if (!row && addButton) {
          addButton.click();
          row = rowsContainer ? rowsContainer.querySelector("[data-fornecedor-row]") : null;
        }
        if (row) {
          var caInput = row.querySelector("[data-field='ca']");
          if (caInput && data.ca) {
            caInput.value = data.ca;
          }
          var fornecedorSelect = row.querySelector("[data-field='fornecedor']");
          if (fornecedorSelect && data.fornecedorId) {
            var existing = Array.from(fornecedorSelect.options).find(function (option) {
              return String(option.value) === String(data.fornecedorId);
            });
            if (!existing && data.fornecedorNome) {
              var newOption = document.createElement("option");
              newOption.value = String(data.fornecedorId);
              newOption.textContent = data.fornecedorNome;
              fornecedorSelect.appendChild(newOption);
            }
            fornecedorSelect.value = String(data.fornecedorId);
          } else if (fornecedorSelect && data.fornecedor) {
            var target = data.fornecedor.trim().toLowerCase();
            var matched = Array.from(fornecedorSelect.options).find(function (option) {
              return option.text.trim().toLowerCase() === target;
            });
            if (!matched) {
              matched = Array.from(fornecedorSelect.options).find(function (option) {
                return option.text.trim().toLowerCase().indexOf(target) !== -1;
              });
            }
            if (matched) {
              fornecedorSelect.value = matched.value;
            }
          }
        }

        var firstTab = modal.querySelector("[data-produto-tabs] .nav-link");
        if (firstTab && window.bootstrap) {
          var tabInstance = bootstrap.Tab.getOrCreateInstance(firstTab);
          tabInstance.show();
        }
      }

      initProdutoModal(modalEl);

      document.addEventListener("click", function (event) {
        var trigger = event.target.closest("[data-ca-import-button]");
        if (!trigger) {
          return;
        }
        event.preventDefault();
        if (successAlert) {
          successAlert.classList.add("d-none");
        }
        var payload = {
          nome: trigger.getAttribute("data-ca-nome") || "",
          referencia: trigger.getAttribute("data-ca-referencia") || "",
          fornecedor: trigger.getAttribute("data-ca-fornecedor") || "",
          ca: trigger.getAttribute("data-ca-registro") || "",
        };

        function openModal() {
          if (window.bootstrap) {
            var instance = bootstrap.Modal.getOrCreateInstance(modalEl);
            instance.show();
          }
        }

        function getCookie(name) {
          var value = "; " + document.cookie;
          var parts = value.split("; " + name + "=");
          if (parts.length === 2) {
            return parts.pop().split(";").shift();
          }
          return "";
        }

        function ensureFornecedor(nome) {
          if (!fornecedorUrl || !nome) {
            return Promise.resolve(null);
          }
          var body = new URLSearchParams();
          body.set("nome", nome);
          return fetch(fornecedorUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": getCookie("csrftoken"),
              "X-Requested-With": "XMLHttpRequest",
            },
            body: body.toString(),
          })
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (data && data.ok) {
                return { id: data.id, nome: data.nome };
              }
              return null;
            })
            .catch(function () { return null; });
        }

        ensureFornecedor(payload.fornecedor).then(function (fornecedorInfo) {
          if (fornecedorInfo) {
            payload.fornecedorId = fornecedorInfo.id;
            payload.fornecedorNome = fornecedorInfo.nome;
          }
          openModal();
          fillProdutoModal(modalEl, payload);
        });
      });
    });
  </script>
{% endblock %}
